
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TINKTEP and polarisable embedding: linear-scaling QM/polarisable-MM &#8212; ONETEP Documentation 6.2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '6.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Properties" href="index_properties.html" />
    <link rel="prev" title="QM/MM (TINKTEP) and Polarisable Embedding" href="index_qmmm.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tinktep-and-polarisable-embedding-linear-scaling-qm-polarisable-mm">
<h1>TINKTEP and polarisable embedding: linear-scaling QM/polarisable-MM<a class="headerlink" href="#tinktep-and-polarisable-embedding-linear-scaling-qm-polarisable-mm" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Jacek Dziedzic, University of Southampton</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">May 2018</td>
</tr>
</tbody>
</table>
<p>This manual pertains to ONETEP versions v4.5.18.8 and later, and TINKTEP
versions v1.19 and later.</p>
<div class="section" id="executive-summary">
<h2>Executive summary<a class="headerlink" href="#executive-summary" title="Permalink to this headline">¶</a></h2>
<p>TINKTEP [Dziedzic2016], [Dziedzic2018] is an interface between
ONETEP and TINKER (an implementation of the AMOEBA force-field). It
enables QM/MM calculations, where ONETEP is used as the QM engine, and
TINKER is used as the MM engine. The two main distinguishing features of
TINKTEP are the linear scaling of the QM part (subject to usual ONETEP
linear scaling caveats), and the fact that the MM side uses a
polarisable force field (AMOEBA). There is full mutual self-consistency
between the QM and MM subsystem – the QM subsystem polarises the MM
subsystem and vice versa. Van der Waals interactions between QM and MM
are also taken care of. TINKTEP is work in progress, both on the front
of theory (improving the model) and implementation (adding desired
features, simplifying use). It is currently not distributed to end users
and not fully supported at the level we support mainstream ONETEP
features.</p>
</div>
<div class="section" id="main-limitations">
<h2>Main limitations<a class="headerlink" href="#main-limitations" title="Permalink to this headline">¶</a></h2>
<p>Some of these might be deal-breakers for you, so make sure you read this
carefully.</p>
<ul class="simple">
<li>You must obtain and install TINKER separately, and then patch it
using the provided patches.</li>
<li>The filesystem on the node from which you submit parallel jobs must
be visible on the compute nodes. This can make set-up tricky on
systems like ARCHER, where there is an intermediate layer of MOM
nodes between the login node and the compute nodes. Currently it’s
easiest to run TINKTEP on single-node desktop machines, where you can
leverage MPI and OMP parallelism without the hassle of a batch
system.</li>
<li>Only open boundary conditions (OBCs) are supported so far. The QM
calculation is performed in OBCs, with the QM subsystem embedded in
MM point charges, dipoles, quadrupoles and polarisable dipoles. The
MM calculation is performed in OBCs. You will not be able to simulate
e.g.&nbsp;a QM subsystem in a periodic box of water, for instance, but
using a large sphere of MM water molecules is a decent workaround. We
plan to support PBCs in the future.</li>
<li>QM/MM forces, molecular dynamics, geometry optimisation and
transition state search are all not available currently.</li>
<li>Covalent bonds spanning the QM/MM interface are not supported.</li>
<li>All QM species must have identical NGWF radii. Without this
simplification the numerical methods used in SWRI (refer to
“Spherical-wave resolution of identity, distributed multipole
analysis (DMA) and Hartree-Fock exchange” manual for more details)
would get ugly. Typically this is a non-issue, just increase the NGWF
radii to the largest value. This might admittedly be an issue if you
have a single species that requires a large NGWF radius. This is
checked against and ONETEP will not let you do SWRI unless all NGWF
radii are identical.</li>
<li>TINKTEP is currently incompatible with complex NGWFs and ONETEP will
refuse to use both.</li>
<li>The TINKTEP1 model uses a classical model for QM/MM van der Waals
interactions. The TINKTEP2 model uses a quantum-classical model for
QM/MM van der Waals interactions, which requires suitable vdW
parameters for all MM species that you use. We only provide these
parameters for water, K<span class="math">\(^{+}\)</span> and Cl<span class="math">\(^{-}\)</span>, so
applications of TINKTEP2 are restricted to embedding a QM subsystem
in water or KCl solutions, unless you wish to determine suitable MM
vdW parameters yourself. These are <strong>not</strong> the familiar LJ parameters
<span class="math">\(\sigma\)</span> and <span class="math">\(\epsilon\)</span> .</li>
</ul>
</div>
<div class="section" id="basics">
<h2>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>Consult [Dziedzic2016] for a detailed exposure of the
theory behind the model. Consult [Dziedzic2018] for a
description of TINKTEP2 and how it differs from TINKTEP1. This manual
takes a hands-on approach, but assumes you are familiar with the theory.
This manual should be suitable for both TINKTEP1 and TINKTEP2, but the
former will likely be discontinued in the future.</p>
<p>TINKTEP uses Distributed Multipole Analysis
(DMA) [Stone1998], [Stone2005], [Vitale2015] to build an auxiliary
representation (termed QM<span class="math">\(^*\)</span>) of the QM subsystem as a set of
multipoles. Make sure you are famliar with DMA and SWRI (“Spherical-wave
resolution of identity, distributed multipole analysis (DMA) and
Hartree-Fock exchange”) beforehand.</p>
</div>
<div class="section" id="setting-up-your-computational-environment">
<h2>Setting up your computational environment<a class="headerlink" href="#setting-up-your-computational-environment" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Obtain a copy of TINKER v7.1.3. This should be available at no cost
from Jay Ponder’s website. It is imperative that you use v7.1.3 or
else the patches supplied with ONETEP will not work.</li>
<li>Patch your copy of TINKER using the set of patches located in
<code class="docutils literal"><span class="pre">utils/tinktep/tinktep_patches</span></code>. Make sure they all applied
correctly.</li>
<li>Compile and install your patched copy of TINKER.</li>
<li>Ensure that at least the following executables from the TINKER suite
can be found in your <code class="docutils literal"><span class="pre">PATH</span></code>: <code class="docutils literal"><span class="pre">analyze</span></code>, <code class="docutils literal"><span class="pre">dynamic</span></code>, <code class="docutils literal"><span class="pre">poledit</span></code>.</li>
<li>Compile ONETEP v4.5.18.8 or later.</li>
<li>Ensure all scripts supplied in <code class="docutils literal"><span class="pre">utils/tinktep</span></code> can be found in your
<code class="docutils literal"><span class="pre">PATH</span></code>.</li>
</ol>
</div>
<div class="section" id="setting-up-a-qm-mm-calculation">
<h2>Setting up a QM/MM calculation<a class="headerlink" href="#setting-up-a-qm-mm-calculation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="input-xyz-file">
<h3>Input <code class="docutils literal"><span class="pre">.xyz</span></code> file<a class="headerlink" href="#input-xyz-file" title="Permalink to this headline">¶</a></h3>
<p>First, prepare your complete QM+MM system in the form of a TINKER
<code class="docutils literal"><span class="pre">.xyz</span></code> file. This format differs from the four-column (species,
<span class="math">\(x\)</span>, <span class="math">\(y\)</span>, <span class="math">\(z\)</span>) <code class="docutils literal"><span class="pre">.xyz</span></code> file you might be familiar
with. Consult the TINKER manual for the details of the format. In
further text “<code class="docutils literal"><span class="pre">.xyz</span></code> format” will implicitly mean the TINKER <code class="docutils literal"><span class="pre">.xyz</span></code>
format. If your <code class="docutils literal"><span class="pre">.xyz</span></code> file came from a TINKER MD simulation, no
adjustments are necessary. If you are creating the <code class="docutils literal"><span class="pre">.xyz</span></code> file on your
own, make sure you get the atom types and classes right, and the
connectivity too – as prescribed by your MM <code class="docutils literal"><span class="pre">.prm</span></code> file
(e.g.&nbsp;<code class="docutils literal"><span class="pre">amoeba09.prm</span></code>). If you do not know what atom types to choose
for what will be your QM atoms, do not worry particularly, just make
sure they roughly match their classical equivalents in the <code class="docutils literal"><span class="pre">.prm</span></code> file
in terms of chemical species, hybridisation (sp2, sp3, etc.) and
connectivity. What will only matter will be their polarisabilities (for
correct Thole damping of induced QM/MM interactions) and classical vdW
parameters (for QM/MM vdW energies (both the repulsive and dispersive
term in TINKTEP1, dispersive term only in TINKTEP2).</p>
<p>An example <code class="docutils literal"><span class="pre">.xyz</span></code> file for a water dimer (one water molecule in QM,
one water molecule in MM) could look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">6</span>
<span class="mi">1</span>  <span class="n">O</span>      <span class="mf">0.583801</span>    <span class="mf">0.000000</span>    <span class="mf">0.759932</span>    <span class="mi">36</span>     <span class="mi">2</span>     <span class="mi">3</span>
<span class="mi">2</span>  <span class="n">H</span>      <span class="mf">0.000000</span>    <span class="mf">0.000000</span>    <span class="mf">0.000000</span>    <span class="mi">37</span>     <span class="mi">1</span>
<span class="mi">3</span>  <span class="n">H</span>      <span class="mf">0.000000</span>    <span class="mf">0.000000</span>    <span class="mf">1.530090</span>    <span class="mi">37</span>     <span class="mi">1</span>
<span class="mi">4</span>  <span class="n">O</span>     <span class="o">-</span><span class="mf">0.687305</span>    <span class="mf">0.000000</span>    <span class="mf">2.795684</span>    <span class="mi">36</span>     <span class="mi">5</span>     <span class="mi">6</span>
<span class="mi">5</span>  <span class="n">H</span>     <span class="o">-</span><span class="mf">0.448269</span>   <span class="o">-</span><span class="mf">0.763921</span>    <span class="mf">3.325671</span>    <span class="mi">37</span>     <span class="mi">4</span>
<span class="mi">6</span>  <span class="n">H</span>     <span class="o">-</span><span class="mf">0.448269</span>    <span class="mf">0.763921</span>    <span class="mf">3.325671</span>    <span class="mi">37</span>     <span class="mi">4</span>
</pre></div>
</div>
<p>In the above 36 and 37 are atom types as defined in <code class="docutils literal"><span class="pre">amoeba09.prm</span></code>,
and the last two colums define connectivity. Do not worry about the
absolute positioning of the molecule (if it crosses zero in any of the
directions) – TINKER will work in OBC mode and will not attempt to wrap
your atoms back to the simulation cell, because there is none. ONETEP
will work with a suitably translated version of the molecule anyway.</p>
</div>
<div class="section" id="input-tag-file">
<h3>Input <code class="docutils literal"><span class="pre">.tag</span></code> file<a class="headerlink" href="#input-tag-file" title="Permalink to this headline">¶</a></h3>
<p>Now we need to designate each atom as part of the QM subsystem or the MM
subsystem. This is done via a <code class="docutils literal"><span class="pre">.tag</span></code> file. This file should contain
two or three lines. The first line specifies the indices of atoms
belonging to the QM subsystem. The second line specifies the indices of
atoms belonging to the MM subsystem, like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span>
<span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span>
</pre></div>
</div>
<p>The above assigns the first water molecule to the QM subsystem, and the
second water molecule to the MM subsystem. In the <code class="docutils literal"><span class="pre">.tag</span></code> file, all
atoms must be accounted for. If you want TINKTEP to ignore some atoms
(say, you have <code class="docutils literal"><span class="pre">.xyz</span></code> file of a large system and want to discard some
of it), put their indices in the third line. Normally you would simply
omit the third line. It is not permitted for covalent bonds to span the
QM/MM interface, and TINKTEP will refuse to proceed if it detects this.
For instance this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">2</span>
<span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span>
</pre></div>
</div>
<p>would not be a valid <code class="docutils literal"><span class="pre">.tag</span></code> file.</p>
<p>If you want <em>no</em> atoms in the QM subsystem (for a purely MM calculation)
or the MM subsystem (for a purely QM calculation), put <code class="docutils literal"><span class="pre">-1</span></code> in the
corresponding line, rather than leaving it blank.</p>
<p>Do not put any comments or additional information in the <code class="docutils literal"><span class="pre">.tag</span></code> file,
that would make it misformatted.</p>
<p>Rename your <code class="docutils literal"><span class="pre">.tag</span></code> file to use the same base name as the <code class="docutils literal"><span class="pre">.xyz</span></code> file
(say, <code class="docutils literal"><span class="pre">my_molecule.tag</span></code> and <code class="docutils literal"><span class="pre">my_molecule.xyz</span></code>).</p>
</div>
<div class="section" id="input-key-file">
<h3>Input <code class="docutils literal"><span class="pre">.key</span></code> file<a class="headerlink" href="#input-key-file" title="Permalink to this headline">¶</a></h3>
<p>Create a <code class="docutils literal"><span class="pre">.key</span></code> file with the same base name as the <code class="docutils literal"><span class="pre">.xyz</span></code> and
<code class="docutils literal"><span class="pre">.tag</span></code> files, and with the following contents:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">digits</span> <span class="mi">9</span>
<span class="n">parameters</span> <span class="n">amoeba09</span>
</pre></div>
</div>
<p>The line with <code class="docutils literal"><span class="pre">digits</span> <span class="pre">9</span></code> is necessary to force TINKER to use extra
precision in its outputs. The second line specifies the MM parameter
file for TINKER. Adjust it if you want to use a file different from
<code class="docutils literal"><span class="pre">amoeba09.prm</span></code>.</p>
</div>
<div class="section" id="input-dat-template-file">
<h3>Input <code class="docutils literal"><span class="pre">.dat.template</span></code> file<a class="headerlink" href="#input-dat-template-file" title="Permalink to this headline">¶</a></h3>
<p>Create a <code class="docutils literal"><span class="pre">.dat.template</span></code> file with the same base name as the <code class="docutils literal"><span class="pre">.xyz</span></code>,
<code class="docutils literal"><span class="pre">.tag</span></code> and <code class="docutils literal"><span class="pre">.key</span></code> files. Populate this file with the keywords you
want to be passed to ONETEP. Essentially, this file will be slightly
modified by TINKTEP (specifically by <code class="docutils literal"><span class="pre">qm_xyz_to_dat</span></code>) and will become
the <code class="docutils literal"><span class="pre">.dat</span></code> that ONETEP will read. The modifications undertaken by
TINKTEP are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pol_emb_pot_filename</span></code> will be added <a class="footnote-reference" href="#id13" id="id8">[1]</a> to instruct ONETEP to
perform a QM/MM calculation and inform it about the name of the file
used for communicating between ONETEP and TINKER.</li>
<li><code class="docutils literal"><span class="pre">pol_emb_polscal</span></code> will be set accordingly if <code class="docutils literal"><span class="pre">qm_mm_polscal</span></code> was
set in <code class="docutils literal"><span class="pre">tinktep.config</span></code>.</li>
<li><code class="docutils literal"><span class="pre">pol_emb_thole_a</span></code> will be set accordingly if <code class="docutils literal"><span class="pre">qm_mm_thole_a</span></code> was
set in <code class="docutils literal"><span class="pre">tinktep.config</span></code>.</li>
<li><code class="docutils literal"><span class="pre">pol_emb_fixed_charge</span> <span class="pre">T</span></code> will be added if the MM force field is
<em>not</em> polarisable (e.g.&nbsp;GAFF), to inform ONETEP about this fact.</li>
<li>A <code class="docutils literal"><span class="pre">%block</span> <span class="pre">positions_abs</span></code> will be added, containing the species and
positions of QM atoms inferred from the <code class="docutils literal"><span class="pre">.xyz</span></code> and <code class="docutils literal"><span class="pre">.tag</span></code> files,
suitably translated.</li>
<li>If <code class="docutils literal"><span class="pre">tinktep.config</span></code> specified <code class="docutils literal"><span class="pre">qm_thole_polarisability</span></code>, a
<code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code> will be added, containing the Thole
polarisabilities of QM atoms inferred from the <code class="docutils literal"><span class="pre">.prm</span></code> and <code class="docutils literal"><span class="pre">.tag</span></code>
files.</li>
<li>If the scenario of a purely QM calculation with classical atoms
(“sparkles”) has been selected by specifying <code class="docutils literal"><span class="pre">classical_atoms</span></code> in
<code class="docutils literal"><span class="pre">tinktep.config</span></code>, a <code class="docutils literal"><span class="pre">%block</span> <span class="pre">classical_info</span></code> will be added,
containing the species and positions of MM atoms inferred from the
<code class="docutils literal"><span class="pre">.xyz</span></code> and <code class="docutils literal"><span class="pre">.tag</span></code> files, suitably translated.</li>
<li>If the <code class="docutils literal"><span class="pre">.xyz</span></code> file contained a bounding box (for PBC calculations),
a suitable <code class="docutils literal"><span class="pre">%block</span> <span class="pre">lattice_cart</span></code> will be added to match the MM box
size. PBCs are not supported yet, do not rely on this functionality.</li>
</ul>
<p>Basically, what you put in the <code class="docutils literal"><span class="pre">.dat.template</span></code> file should look like a
normal ONETEP <code class="docutils literal"><span class="pre">.dat</span></code> file, <em>except for</em> the positions of atoms. Do not
attempt to create a <code class="docutils literal"><span class="pre">.dat</span></code> file on your own, leave it to TINKTEP to
create it automatically when it is run. For instance, for our water
dimer example you could use this bare-bones <code class="docutils literal"><span class="pre">.dat.template</span></code> file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>! --- usual ONETEP keywords ---
%block species_atomic_set
H  &quot;SOLVE&quot;
O  &quot;SOLVE&quot;
%endblock species_atomic_set

%block species
H  H 1 1 7.0
O  O 8 4 7.0
%endblock species

%block species_pot
H  &#39;H_04.recpot&#39;
O  &#39;O_02.recpot&#39;
%endblock species_pot

%block lattice_cart
30.0  0.0  0.0
 0.0 30.0  0.0
 0.0  0.0 30.0
%endblock lattice_cart

cutoff_energy 1000 eV
charge 0
xc_functional PBE
dispersion 1

! --- cutoff Coulomb to enforce OBCs in ONETEP ---
coulomb_cutoff_type SPHERE
coulomb_cutoff_radius 40.0 bohr
coulomb_cutoff_write_int F

! --- DMA setup, needed for QM/MM. Consult DMA manual for details ---
%block swri
  for_dma 1 12 V 12 12 W
%endblock swri

%block species_swri-for_dma
H
O
%endblock species_swri-for_dma

dma_calculate T
dma_use_ri for_dma
dma_max_l 1
dma_max_q 12
dma_metric ELECTROSTATIC
dma_bessel_averaging T
dma_scale_charge F

! --- Polarisable embedding, needed for QM/MM. See further text. ---
pol_emb_dma_min_l 0
pol_emb_dma_max_l 1
pol_emb_mpole_exclusion_radius 1.00 bohr
pol_emb_repulsive_mm_pot_cutoff 10.0 bohr

%block mm_rep_params
H   35 2.400 ! follows TINKTEP-2 paper
O  550 1.580 ! follows TINKTEP-2 paper
%endblock mm_rep_params
</pre></div>
</div>
</div>
<div class="section" id="tinkers-prm-file">
<h3>TINKER’s <code class="docutils literal"><span class="pre">.prm</span></code> file<a class="headerlink" href="#tinkers-prm-file" title="Permalink to this headline">¶</a></h3>
<p>Copy the <code class="docutils literal"><span class="pre">.prm</span></code> file of your choice (typically <code class="docutils literal"><span class="pre">amoeba09.prm</span></code>) to
the same directory where you put the <code class="docutils literal"><span class="pre">.xyz</span></code>, <code class="docutils literal"><span class="pre">.tag</span></code>, <code class="docutils literal"><span class="pre">.key</span></code> and
<code class="docutils literal"><span class="pre">.dat.template</span></code> files. Do not rename it. Ensure its basename is
reflected in the <code class="docutils literal"><span class="pre">parameters</span></code> keyword in the <code class="docutils literal"><span class="pre">.key</span> <span class="pre">file</span></code>.</p>
</div>
<div class="section" id="tinktep-config-file">
<h3><code class="docutils literal"><span class="pre">tinktep.config</span></code> file<a class="headerlink" href="#tinktep-config-file" title="Permalink to this headline">¶</a></h3>
<p>This is the main file for controlling the QM/MM calculation. Its name is
fixed, do not change it. Here’s an example suitable for our water dimer,
using the TINKTEP2 model:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jobname</span> <span class="n">water_dimer</span>

<span class="c1"># *** Computational environment set-up ***</span>
<span class="n">tinker_nthreads</span> <span class="mi">8</span>
<span class="n">onetep_nranks</span> <span class="mi">2</span>
<span class="n">onetep_nthreads</span> <span class="mi">8</span>
<span class="n">onetep_executable</span> <span class="o">./</span><span class="n">onetep</span><span class="o">.</span><span class="n">RH7</span>
<span class="n">mpirun_executable</span> <span class="n">mpirun</span>

<span class="c1"># *** Nuts and bolts of the QM/MM interface ***</span>
<span class="n">qm_mm_polscal</span> <span class="mf">6.0</span>
<span class="n">qm_polarisability</span>
<span class="n">qm_thole_polarisability</span>
<span class="n">renumber_offset</span> <span class="mi">500</span>

<span class="c1"># *** Physics ***</span>

<span class="c1"># Undamped fixed, permanent multipoles using the full density representation,</span>
<span class="c1"># and Thole-damped induced dipoles using the QM* representation. MM repulsive potential.</span>
<span class="n">onetep_perm_mpoles</span>     <span class="n">perm_fix_rep</span> <span class="n">potential_coulombic_smeared</span> <span class="n">energy_from_potential</span>
<span class="n">onetep_induced_dipoles</span> <span class="n">ind_qmstar</span>   <span class="n">potential_thole_damped</span>      <span class="n">energy_from_potential</span>

<span class="c1"># TINKER handles all bonded (valence) terms between MM atoms.</span>
<span class="n">tinker_bond_energy</span> <span class="mi">1</span>
<span class="n">tinker_angle_energy</span> <span class="mi">1</span>
<span class="n">tinker_ureybrad_energy</span> <span class="mi">1</span>

<span class="c1"># TINKER handles MM electrostatics.</span>
<span class="n">tinker_mm_perm_energy</span> <span class="mi">1</span>
<span class="n">tinker_mm_pol_energy</span> <span class="mi">1</span>

<span class="c1"># ONETEP handles QM/MM electrostatics.</span>
<span class="n">tinker_qm_mm_perm_energy</span> <span class="mi">0</span>
<span class="n">tinker_qm_mm_pol_energy</span> <span class="mi">0</span>

<span class="c1"># TINKER handles van der Waals for MM, and only the dispersive term for QM/MM.</span>
<span class="n">tinker_mm_vdw_energy</span> <span class="mi">1</span>
<span class="n">tinker_qm_mm_vdw_energy</span> <span class="mi">2</span>
</pre></div>
</div>
<p>All <code class="docutils literal"><span class="pre">tinktep.config</span></code> keywords will be described later.</p>
</div>
</div>
<div class="section" id="running-a-qm-mm-calculation">
<h2>Running a QM/MM calculation<a class="headerlink" href="#running-a-qm-mm-calculation" title="Permalink to this headline">¶</a></h2>
<p>Once you have all input files in place, simply type <code class="docutils literal"><span class="pre">tinktep</span></code> to run
the QM/MM calculation. Expect the following to happen:</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">xyz_split</span></code> will be run to split your <code class="docutils literal"><span class="pre">.xyz</span></code> file into a
<code class="docutils literal"><span class="pre">qm.xyz</span></code> and a <code class="docutils literal"><span class="pre">mm.xyz</span></code> file, based on the contents of the
<code class="docutils literal"><span class="pre">.tag</span></code> file.</li>
<li><code class="docutils literal"><span class="pre">qm_xyz_to_dat</span></code> will be run to build a ONETEP <code class="docutils literal"><span class="pre">.dat</span></code> file from
the <code class="docutils literal"><span class="pre">.dat.template</span></code> file and the <code class="docutils literal"><span class="pre">qm.xyz</span></code> file, using information
from the <code class="docutils literal"><span class="pre">.prm</span></code> file.</li>
<li>A pair of FIFOs (<code class="docutils literal"><span class="pre">$QM2MM.lock</span></code> and <code class="docutils literal"><span class="pre">$MM2QM.lock</span></code>) will be
created. These will be used for interprocess communication (ONETEP to
TINKTEP and TINKTEP to ONETEP).</li>
<li>ONETEP will be started in the background (via <code class="docutils literal"><span class="pre">mpirun</span></code> or
equivalent).</li>
<li>A watchdog process will be started in the background. It will keep an
eye on the <code class="docutils literal"><span class="pre">mpirun</span></code> process that launched ONETEP and on ONETEP’s
<code class="docutils literal"><span class="pre">.err</span></code> and <code class="docutils literal"><span class="pre">.error_message</span></code> files. It will attempt to clean up
gracefully if it decides that ONETEP crashed or was killed.</li>
<li>[scf]TINKTEP will block until it ONETEP reaches a point where total
energy needs to be evaluated. Then it will resume.</li>
<li>TINKTEP will read the <code class="docutils literal"><span class="pre">.gdma_like.txt</span></code> file produced by ONETEP.
This file contains the multipole representation of the QM subsystem.
It will run TINKER’s <code class="docutils literal"><span class="pre">poledit</span></code> to process these multipoles.</li>
<li><code class="docutils literal"><span class="pre">xyz_process</span></code> will be run to process the <code class="docutils literal"><span class="pre">qm.xyz</span></code> and <code class="docutils literal"><span class="pre">mm.xyz</span></code>
files to a form digestible by TINKER (<code class="docutils literal"><span class="pre">qm_mm.xyz</span></code> file). This is
mostly about renumbering the atom types in the QM subsystem so that
they do not clash with the types in the <code class="docutils literal"><span class="pre">.prm</span></code> file.</li>
<li><code class="docutils literal"><span class="pre">key_process</span></code> will be run to prepare a suitable <code class="docutils literal"><span class="pre">.key</span></code> file for
TINKER (<code class="docutils literal"><span class="pre">qm_mm.key</span></code>). This takes the contents of the original
<code class="docutils literal"><span class="pre">.key</span></code> file, and modifies it accordingly so that it is digestible
by TINKER. For instance dummy bond and angle parameters will be
supplied for the QM atoms, QM sites and multipoles will be
renumbered, polarisabilities of QM atoms will be defined, the QM
subsystem will be made inactive and “only formally polarisable”,
etc..</li>
<li>TINKER (specifically <code class="docutils literal"><span class="pre">analyze</span></code> and <code class="docutils literal"><span class="pre">dynamic</span></code>) will be run to
obtain the polarisation response of the MM subsystem, all of MM
electrostatics, QM/MM electrostatics, QM/MM van der Waals energies,
MM van der Waals and MM bonded interactions. Not all of these terms
will necessarily be used in the final energy expression.</li>
<li><code class="docutils literal"><span class="pre">mpoles_process</span></code> will be run to process TINKER’s multipoles and
energy terms into a format understandable by ONETEP
(<code class="docutils literal"><span class="pre">.mpoles_for_onetep</span></code> file).</li>
<li>ONETEP will resume, after having been pinged via <code class="docutils literal"><span class="pre">$MM2QM.lock</span></code>.</li>
<li>If SCF convergence has been reached, TINKTEP will terminate with a
short summary. If not, control will transfer to step [scf].</li>
</ol>
<p>All in all, the TINKTEP script drives both ONETEP and TINKER. ONETEP is
executed once, in the background, and is resumed when necessary. TINKER
is started each time ONETEP performs an energy evaluation. TINKER, which
does not support MPI parallelism, is run on the local node (possibly
using OMP threads). ONETEP is started via <code class="docutils literal"><span class="pre">mpirun</span></code> or equivalent, and
it’s the user’s responsibility to set the parallel environment in such a
way, that ONETEP gets started on the appropriate nodes (e.g.&nbsp;via a
hostfile).</p>
<p>All ONETEP output goes to a <code class="docutils literal"><span class="pre">qm_mm.out</span></code> file with the same base name
as the input. All ONETEP error messages go to a <code class="docutils literal"><span class="pre">qm_mm.err</span></code> file with
the same base name as the input. TINKTEP’s output goes to <code class="docutils literal"><span class="pre">stdout</span></code>
and <code class="docutils literal"><span class="pre">stderr</span></code>. TINKTEP attempts to detect a large variety of error
conditions and should at least provide an informative error message if
something goes wrong. When diagnosing errors, examine <code class="docutils literal"><span class="pre">stderr</span></code>,
ONETEP’s <code class="docutils literal"><span class="pre">qm_mm.err</span></code> file, ONETEP’s <code class="docutils literal"><span class="pre">qm_mm.error_message</span></code> file
(if any), and see if there’s a file called <code class="docutils literal"><span class="pre">error_message</span></code> (with no
base name) – it is created when more exotic error conditions occur.</p>
<p>All intermediate files are automatically moved to a subdirectory called
<code class="docutils literal"><span class="pre">intermediate</span></code> (at each SCF iteration), they are tagged with an SCF
iteration (energy evaluation) number. It is safe to delete this
directory after the calculation has run, it’s mostly useful when
diagnosing problems.</p>
</div>
<div class="section" id="output-from-a-qm-mm-calculation">
<h2>Output from a QM/MM calculation<a class="headerlink" href="#output-from-a-qm-mm-calculation" title="Permalink to this headline">¶</a></h2>
<p>Your <code class="docutils literal"><span class="pre">qm_mm.out</span></code> file will contain usual ONETEP output, interspersed
with a lot of informative messages from DMA and polarisable embedding.
Every time the energy is evaluated, you will get a detailed breakdown of
energies associated with the QM/MM interface. Here’s what it looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>/~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\
| Polarisable embedding potential from water_dimer_mm.mpoles_for_onetep        |
| Multipole set &quot;perm_fix_rep&quot;: 6 sites.                                       |
| Multipole set &quot;ind_qmstar&quot;: 6 sites.                                         |
| All in all 12 sites, and 11 external energy terms (out of which 3 #ignored). |
| Energy term                              Energy      Source   Included?      |
| - MMv bond stretch                   0.000013814 Ha  TINKER      YES         |
| - MMv angle bend                     0.000229041 Ha  TINKER      YES         |
| - MMv Urey-Bradley                  -0.000000274 Ha  TINKER      YES         |
| - #QM/MM perm mpole                 -0.032818501 Ha  TINKER       NO         |
| - #QM/MM polarisation               -0.000794393 Ha  TINKER       NO         |
| - MM perm mpole                      0.000000000 Ha  TINKER      YES         |
| - MM+ polarisation                   0.000000000 Ha  TINKER      YES         |
| - #QM/MM vdW-rep                     0.050008920 Ha  TINKER       NO         |
| - QM/MM vdW-disp                    -0.013332666 Ha  TINKER      YES         |
| - MM vdW-rep                         0.000000000 Ha  TINKER      YES         |
| - MM vdW-disp                        0.000000000 Ha  TINKER      YES         |
| - QM elec &lt;-&gt; rep MM perm_fix        0.033334141 Ha  ONETEP   REPULS  P Fr   |
| - QM elec &lt;-&gt; MM perm_fix_rep        0.229940160 Ha  ONETEP   COUL-S  P Fr   |
| - QM core &lt;-&gt; MM perm_fix_rep       -0.263586238 Ha  ONETEP   COUL-S  P FR   |
| - QM* elec &lt;-&gt; MM ind_qmstar         0.014117659 Ha  ONETEP    THOLE  I*     |
| - QM core &lt;-&gt; MM ind_qmstar         -0.014912052 Ha  ONETEP    THOLE  I*     |
|------------------------------------------------------------------------------|
|                      External |           Internal |         Difference      |
| Permanent:       -0.032818501 |       -0.033646079 |     0.000827577479 (Ha) |
| Induced:         -0.000794393 |       -0.000794393 |    -0.000000000001 (Ha) |
|------------------------------------------------------------------------------|
| Perm embed. potential  min: -0.3743E+01  max:  0.6338E+01  norm:  0.1776E-01 |
\~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~/
</pre></div>
</div>
<p>From the above example you can infer the following:</p>
<ol class="arabic">
<li><p class="first">The file from which ONETEP reads the details of the MM embedding is
<code class="docutils literal"><span class="pre">water_dimer_mm.mpoles_for_onetep</span></code>.</p>
</li>
<li><p class="first">There are two sets of multipoles, with 6 sites each. The first set
entails permanent (<code class="docutils literal"><span class="pre">perm</span></code>) (as in not induced), fixed (<code class="docutils literal"><span class="pre">fix</span></code>) (as
in not variable in time) multipoles that generate a repulsive
(<code class="docutils literal"><span class="pre">rep</span></code>) potential. The second set entails induced (<code class="docutils literal"><span class="pre">ind</span></code>)
multipoles, which interact not with ONETEP’s full electronic
density, but with the QM<span class="math">\(^*\)</span> description (<code class="docutils literal"><span class="pre">qmstar</span></code>). You
probably expected 3, not 6 sites, but the <code class="docutils literal"><span class="pre">.mpoles_for_onetep</span></code> file
also includes QM sites in addition to MM sites. The QM sites are
tagged with “#” and subsequently ignored.</p>
</li>
<li><p class="first">There are 11 energy terms coming from TINKER, but 3 of these will be
ignored by ONETEP in accordance with the user’s wishes. The ignored
terms are prefixed by “#” and have a “NO” in the “Included?” column.
The ignored terms in this case are:</p>
<ul class="simple">
<li>QM interaction with permanent MM multipoles as calculated by
TINKER. This is because we instead use the full density QM
representation (as calculated by ONETEP) for this term, excluding
TINKER’s approximate idea on purpose (compare
<code class="docutils literal"><span class="pre">tinker_qm_mm_perm_energy</span> <span class="pre">0</span></code> earlier).</li>
<li>QM interaction with induced MM multipoles as calculated by TINKER.
This is because we instead use the value calculated by ONETEP for
this term, even though the two should be (and are) identical,
excluding TINKER’s value on purpose (compare
<code class="docutils literal"><span class="pre">tinker_qm_mm_pol_energy</span> <span class="pre">0</span></code> earlier).</li>
<li>Repulsive part of QM/MM van der Waals interaction as calculated by
TINKER. This is because we instead use the repulsive potential
model introduced in TINKTEP2, calculated by ONETEP for this term,
excluding TINKER’s classical value on purpose (compare
<code class="docutils literal"><span class="pre">tinker_qm_mm_vdw_energy</span> <span class="pre">2</span></code> earlier).</li>
</ul>
<p>The other terms coming from TINKER are included. These are: MM
valence terms (<code class="docutils literal"><span class="pre">MMv</span></code>): bond, angle and Urey-Bradley, MM-MM
permanent multipole interactions (zero in this case, as there is only
one molecule in MM, and AMOEBA masked the MM permanent interactions
within the water molecule), MM polarisation (“+” serves as a reminder
that this polarisation is not strictly only due to MM, because of
non-additivity) (again zero in this case, because of masking),
dispersive part of QM/MM van der Waals interactions, and MM/MM vdW
terms (repulsion and dispersion) (also zero, since there is only one
molecule in MM).</p>
</li>
<li><p class="first">There are 5 energy terms coming from ONETEP (denoted by “ONETEP” in
the “Source” column). These are</p>
<ul class="simple">
<li>The interaction of QM electrons with the MM repulsive potential
attached to one of the multipole sets (<code class="docutils literal"><span class="pre">REPULS</span></code>).</li>
<li>The interaction of QM electrons with the permanent MM multipoles,
treated Coulombically with smearing (<code class="docutils literal"><span class="pre">COUL-S</span></code>).</li>
<li>The interaction of QM ionic cores with the permanent MM
multipoles, treated Coulombically with smearing (<code class="docutils literal"><span class="pre">COUL-S</span></code>).</li>
<li>The interaction of QM<span class="math">\(^*\)</span> electrons (i.e.&nbsp;electronic
multipoles) with the induced MM multipoles, treated using Thole
damping (<code class="docutils literal"><span class="pre">THOLE</span></code>).</li>
<li>The interaction of QM ionic cores (i.e.&nbsp;ionic charges) with the
induced MM multipoles, treated using Thole damping (<code class="docutils literal"><span class="pre">THOLE</span></code>).</li>
</ul>
</li>
<li><p class="first">The symbols to the right of the table inform us about the assumptions
ONETEP makes about some energy terms:</p>
<ul class="simple">
<li>Column 1: <code class="docutils literal"><span class="pre">P</span></code> – MM multipole set is permanent, or <code class="docutils literal"><span class="pre">I</span></code> – MM
multipole set is induced. This affects energy expressions –
induced multipoles require work to assemble,
cf. Ref. [Dziedzic2016].</li>
<li>Column 2: <code class="docutils literal"><span class="pre">*</span></code> – calculation uses the QM<span class="math">\(^*\)</span>
representation of the density, or (blank) – calculation uses the
full density.</li>
<li>Column 3: <code class="docutils literal"><span class="pre">F</span></code> – MM multipole set is fixed (its value is
time-independent), so its electrostatic potential can be stored
and reused, or (blank) – MM multipole set is not fixed (then its
electrostatic potential has to be recalculated every time).</li>
<li>Column 4: <code class="docutils literal"><span class="pre">1</span></code> – Energy term has been calculated for the first
time, and will either be reused later (e.g.&nbsp;for QM cores
interacting with permanent MM multipoles) or at least the MM
potential will be reused (e.g.&nbsp;for QM electrons interacting with
permanent MM multipoles), or <code class="docutils literal"><span class="pre">R</span></code> – energy term has just been
reused, or <code class="docutils literal"><span class="pre">r</span></code> – the MM potential has been reused, but the
energy has been recalculated, or (blank) – neither of the above.</li>
<li>Column 5: <code class="docutils literal"><span class="pre">S</span></code> – <code class="docutils literal"><span class="pre">dma_multipole_scaling</span></code> affected this energy
term, or <code class="docutils literal"><span class="pre">s</span></code> – <code class="docutils literal"><span class="pre">pol_emb_perm_scaling</span></code> affected this energy
term. These are expert directives, do not worry about them.</li>
</ul>
</li>
<li><p class="first">This is followed by a summary of QM/MM permanent and QM/MM induced
electrostatics. “External” is TINKER’s idea of these energy terms,
“Internal” is ONETEP’s idea, “Difference” is the difference between
the two. Unless you do something very exotic, like ignoring
polarisation, the row with “Induced” should always match extremely
well, because both ONETEP and TINKER use the same model (QM:math:<cite>^*</cite>
interacting with MM dipoles), and their calculations should match (if
not, this indicates a bug or a set-up problem, and ONETEP will
abort). Unless you do something exotic, like using the QM<span class="math">\(^*\)</span>
for permanent interactions, the row with “Permanent” will not match,
because TINKER uses the QM<span class="math">\(^{*}\)</span> model and thus suffers from
charge penetration, while ONETEP uses the full density for permanent
interactions, arriving at the “right” result. Here, “Difference” is a
good estimate of QM/MM charge penetration error.</p>
</li>
<li><p class="first">The last row gives some statistics about the permanent MM multipole
potential in which QM electrons are embedded.</p>
</li>
</ol>
</div>
<div class="section" id="tinktep-config-directives">
<h2><code class="docutils literal"><span class="pre">tinktep.config</span></code> directives<a class="headerlink" href="#tinktep-config-directives" title="Permalink to this headline">¶</a></h2>
<p>Here is a list of directives understood by TINKTEP that you can put in
the <code class="docutils literal"><span class="pre">tinktep.config</span></code> file. Make sure you spell these right, unlike
ONETEP, TINKTEP <strong>silently ignores</strong> directives it does not recognise.
You can use “#” to denote comment lines. These will be ignored.</p>
<div class="section" id="environment-set-up">
<h3>Environment set-up<a class="headerlink" href="#environment-set-up" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">jobname</span> <span class="pre">(string)</span></code> <strong>[mandatory, basic]</strong> – specifies the base name
for input (<code class="docutils literal"><span class="pre">.xyz</span></code>, <code class="docutils literal"><span class="pre">.tag</span></code>, <code class="docutils literal"><span class="pre">.key</span></code>, <code class="docutils literal"><span class="pre">.dat.template</span></code>), files.
Example: <code class="docutils literal"><span class="pre">jobname</span> <span class="pre">qm_tryptophan_in_40_mm_waters</span></code>.</p>
<p><code class="docutils literal"><span class="pre">onetep_executable</span> <span class="pre">(string)</span></code> <strong>[mandatory, basic]</strong> – specifies the
name of the ONETEP executable that TINKTEP will pass to <code class="docutils literal"><span class="pre">mpirun</span></code> (or
equivalent). This file must be user-executable.</p>
<p><code class="docutils literal"><span class="pre">onetep_nranks</span> <span class="pre">(integer)</span></code> <strong>[mandatory, basic]</strong> – specifies the
number of MPI ranks that TINKTEP will tell <code class="docutils literal"><span class="pre">mpirun</span></code> (or equivalent) to
start ONETEP on.</p>
<p><code class="docutils literal"><span class="pre">onetep_nthreads</span> <span class="pre">(integer)</span></code> <strong>[mandatory, basic]</strong> – specifies the
number of OMP threads that TINKTEP will tell ONETEP to use (by setting
<code class="docutils literal"><span class="pre">OMP_NUM_THREADS</span></code>. You can always override this with specific ONETEP
thread keywords in the <code class="docutils literal"><span class="pre">.dat.template</span></code> file.</p>
<p><code class="docutils literal"><span class="pre">onetep_args</span> <span class="pre">(string)</span></code> <strong>[optional, expert]</strong> – specifies additional
arguments that you might want to pass to ONETEP. These will go between
the ONETEP executable and the ONETEP input file. This only makes sense
if your <code class="docutils literal"><span class="pre">onetep_executable</span></code> actually points to a wrapper script that
will know what to do with these arguments.</p>
<p><code class="docutils literal"><span class="pre">tinker_nthreads</span> <span class="pre">(integer)</span></code> <strong>[optional, intermediate]</strong> – specifies
the number of OMP threads that TINKTEP will tell TINKER to use (by
adding a keyword to <code class="docutils literal"><span class="pre">qm_mm.key</span></code>. If left unspecified, this will be
left at TINKER’s discretion. Caveat: TINKER sometimes carelessly
outputs to <code class="docutils literal"><span class="pre">stdout</span></code> from OMP regions, which can cause a mess. If
TINKTEP complains that it cannot parse TINKER’s output, try setting
this to 1 to disable OMP in TINKER.</p>
<p><code class="docutils literal"><span class="pre">mpirun_executable</span> <span class="pre">(string)</span></code> <strong>[mandatory, basic]</strong> – specifies the
name of the <code class="docutils literal"><span class="pre">mpirun</span></code> executable that TINKTEP will use to launch
ONETEP. Set this to <code class="docutils literal"><span class="pre">mpirun</span></code>, unless your environment uses something
fancier like <code class="docutils literal"><span class="pre">aprun</span></code>, or you want to specify a full path to select a
specific <code class="docutils literal"><span class="pre">mpirun</span></code> executable.</p>
<p><code class="docutils literal"><span class="pre">mpirun_args</span> <span class="pre">(string)</span></code> <strong>[optional, intermediate]</strong> – specifies
additional arguments that you might want to pass to <code class="docutils literal"><span class="pre">mpirun</span></code>. These
will go between the <code class="docutils literal"><span class="pre">mpirun</span></code> executable and <code class="docutils literal"><span class="pre">-np</span> <span class="pre">&lt;onetep_nranks&gt;</span></code>.
Can be useful for passing a hostfile name.</p>
<p><code class="docutils literal"><span class="pre">watchdog_unfazed_by_stderr</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, intermediate]</strong> –
tells TINKTEP’s watchdog not to keep an eye on ONETEP’s <code class="docutils literal"><span class="pre">.err</span></code>
file. Normally any output to this file is an indication that something
went wrong, and the watchdog then initiates cleanup. In some
environments you can get innocuous messages written to a job’s <code class="docutils literal"><span class="pre">.err</span></code>
file, e.g.&nbsp;warnings from MPI or the transport layer. Use this directive
to immunize the watchdog against these.</p>
</div>
<div class="section" id="qm-mm-set-up-basic">
<h3>QM/MM set-up: basic<a class="headerlink" href="#qm-mm-set-up-basic" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">onetep_perm_mpoles</span> <span class="pre">(set_name)</span> <span class="pre">(potential_mode)</span> <span class="pre">(energy_mode)</span></code>
<strong>[mandatory, basic]</strong> – specifies the treatment of permanent MM
multipoles inside ONETEP. All three arguments are strings and are
mandatory. These are extremely important and have to be discussed in
detail.</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">set_name</span></code> – a short, descriptive name that will identify the
permanent MM multipole set in ONETEP. Crucially, this name will also
be parsed by ONETEP to infer the properties of this set. Thus,
certain tokens (substrings) carry very specific meaning in the
context of the name. These are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">perm</span></code> – the set is permanent (as in “not induced”). This
affects energy expressions – induced multipoles require work to
assemble, permanent sets do not,
cf. Ref. [Dziedzic2016].</li>
<li><code class="docutils literal"><span class="pre">ind</span></code> – the set is induced (as in “not permanent”). This affects
energy expressions – induced multipoles require work to assemble,
permanent sets do not, cf. Ref. [Dziedzic2016].</li>
<li><code class="docutils literal"><span class="pre">fix</span></code> – the set is fixed (as in “not changing in time”). This
does not mean “not moving through space” (currently <em>all</em> MM
multipoles are presumed not to be moving through space).
Calculations on fixed sets will be optimised to re-use
electrostatic potentials or entire energy terms.</li>
<li><code class="docutils literal"><span class="pre">qmstar</span></code> – the set uses the QM<span class="math">\(^*\)</span> representation and
not the full QM density when interacting with the QM subsystem. If
absent, the full QM density is used by default.</li>
<li><code class="docutils literal"><span class="pre">rep</span></code> – the set generates an MM repulsive potential (for the
TINKTEP2 model). If absent, no MM repulsive potential will be
generated by the set. Note: If <code class="docutils literal"><span class="pre">rep</span></code> is present for more than
one set, only the last set set will generate the MM repulsive
potential.</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">potential_mode</span></code> – describes how ONETEP generates the electrostatic
potential coming from this multipole set. Four options are possible:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">potential_zero</span></code> – the set does not generate any potential (and
so is essentially ignored).</li>
<li><code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code> – the set generates a Coulombic
potential, with a small degree of smearing only very close to the
location of each point multipole – this is done to avoid
singularities (cf.&nbsp;<code class="docutils literal"><span class="pre">pol_emb_mpole_exclusion_radius</span></code>,
<code class="docutils literal"><span class="pre">polemb_smearing_a</span></code>).</li>
<li><code class="docutils literal"><span class="pre">potential_coulombic_masked</span></code> – the set generates a Coulombic
potential, which is, however, masked (zeroed) very close to the
location of each point multipole – this is done to avoid
singularities (cf.&nbsp;<code class="docutils literal"><span class="pre">pol_emb_mpole_exclusion_radius</span></code>). This is
not recommended, except for tests, use
<code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code> instead.</li>
<li><code class="docutils literal"><span class="pre">potential_thole_damped</span></code> – the set generates a Thole-damped
potential, mimicking AMOEBA polarisation interactions. Thole
damping is a classical scheme and is designed to be applied to
interactions between two point multipoles. Thus it is best suited
to the QM<span class="math">\(^*\)</span> representation (cf.&nbsp;<code class="docutils literal"><span class="pre">qmstar</span></code> above), and
not to interactions between MM point multipoles and the full,
distributed QM density, although this is, in principle, possible.
The magnitude of the damping depends on the polarisabilities of
the two interacting sites. For MM sites the polarisabilities are
determined by the force field (<code class="docutils literal"><span class="pre">.prm</span></code> file). For QM<span class="math">\(^*\)</span>
sites the polarisabilities either have to be specified in the
<code class="docutils literal"><span class="pre">.dat.template</span></code> file (<code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code>), or can
be inferred automatically from the <code class="docutils literal"><span class="pre">.prm</span></code> file. The latter
option is preferred, it can be activated via the directive
<code class="docutils literal"><span class="pre">qm_thole_polarisability</span></code> in <code class="docutils literal"><span class="pre">tinktep.config</span></code>. This instructs
TINKTEP (and <code class="docutils literal"><span class="pre">qm_xyz_to_dat</span></code> in particular) to add a suitable
<code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code> automatically. When an attempt
is made to use Thole damping with a multipole set that does not
specify <code class="docutils literal"><span class="pre">qmstar</span></code>, a Thole-damped potential coming from the set
will need to be integrated with the full QM density, and there is
no corresponding polarisability that can be used in the Thole
damping expression. In this unlikely scenario, the value of
<code class="docutils literal"><span class="pre">pol_emb_pairwise_polarisability</span></code>, with a unit of bohr, is used
for the Thole variable <span class="math">\(A\)</span> (which is otherwise equal to
<span class="math">\(\sqrt{\alpha_1 \alpha_2}\)</span>). The default value of this
parameter corresponds to the average polarisability of all atom
types in AMOEBA09.</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">energy_mode</span></code> – describes how ONETEP calculates the electrostatic
energy of this multipole set interacting with the QM subsystem. Two
options are possible:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">energy_zero</span></code> – the set does not contribute to energy (and so is
essentially ignored).</li>
<li><code class="docutils literal"><span class="pre">energy_from_potential</span></code> – the set’s contribution to energy will
be made consistent with the setting for the potential (see above).</li>
</ul>
<p>Not all combinations of <code class="docutils literal"><span class="pre">potential_mode</span></code> and <code class="docutils literal"><span class="pre">energy_mode</span></code> make
sense. For instance trying to combine <code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code>
with <code class="docutils literal"><span class="pre">energy_zero</span></code> will lead to an inconsistency between the
Hamiltonian and the energy expression, breaking LNV and NGWF
convergence. Using <code class="docutils literal"><span class="pre">energy_from_potential</span></code> is generally the safest
option, as it guarantees consistency.</p>
</li>
</ul>
<p><code class="docutils literal"><span class="pre">onetep_induced_dipoles</span> <span class="pre">(set_name)</span> <span class="pre">(potential_mode)</span> <span class="pre">(energy_mode)</span></code>
<strong>[mandatory, basic]</strong> – specifies the treatment of induced MM dipoles
inside ONETEP. The meaning of the arguments is the same as for
<code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code> above.</p>
<p>Some typical settings for the above two keywords:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Usual TINKTEP2 set-up: Permanent multipoles interact Coulombically with full QM density,</span>
<span class="c1">#                        induced dipoles interact with QM* via Thole damping,</span>
<span class="c1">#                        repulsive MM potential in effect (attached to perm. multipoles)</span>
<span class="n">onetep_perm_mpoles</span>      <span class="n">perm_fix_rep</span>  <span class="n">potential_coulombic_smeared</span>  <span class="n">energy_from_potential</span>
<span class="n">onetep_induced_dipoles</span>  <span class="n">ind_qmstar</span>    <span class="n">potential_thole_damped</span>       <span class="n">energy_from_potential</span>

<span class="c1"># Usual TINKTEP1 set-up: Permanent multipoles interact Coulombically with full QM density,</span>
<span class="c1">#                        induced dipoles interact with QM* via Thole damping,</span>
<span class="c1">#                        no repulsive MM potential in effect.</span>
<span class="n">onetep_perm_mpoles</span>      <span class="n">perm_fix</span>      <span class="n">potential_coulombic_smeared</span>  <span class="n">energy_from_potential</span>
<span class="n">onetep_induced_dipoles</span>  <span class="n">ind_qmstar</span>    <span class="n">potential_thole_damped</span>       <span class="n">energy_from_potential</span>

<span class="c1"># TINKTEP2 set-up for a non-polarisable force-field (eg. GAFF).</span>
<span class="n">onetep_perm_mpoles</span>      <span class="n">perm_fix_rep</span>  <span class="n">potential_coulombic_smeared</span>  <span class="n">energy_from_potential</span>
<span class="n">onetep_induced_dipoles</span>  <span class="n">ind_qmstar</span>    <span class="n">potential_zero</span>               <span class="n">energy_from_potential</span>

<span class="c1"># TINKTEP2 set-up, where both permanent and induced interactions use QM* and Thole damping</span>
<span class="n">onetep_perm_mpoles</span>      <span class="n">perm_fix_rep_qmstar</span>  <span class="n">potential_thole_damped</span>  <span class="n">energy_from_potential</span>
<span class="n">onetep_induced_dipoles</span>  <span class="n">ind_qmstar</span>           <span class="n">potential_thole_damped</span>  <span class="n">energy_from_potential</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">qm_thole_polarisability</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, basic]</strong> – asks
TINKTEP to automatically infer the Thole polarisabilities of QM sites
from the <code class="docutils literal"><span class="pre">.prm</span></code> file and to automatically add a suitable
<code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code> to the <code class="docutils literal"><span class="pre">.dat</span></code> file. Strongly
recommended.</p>
<p><code class="docutils literal"><span class="pre">qm_polarisability</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, basic]</strong> – forces TINKER to
treat QM sites as “formally polarisable”, that is, to take their
polarisabilities into account in Thole damping expressions, but not to
put induced dipoles on them. Treat this directive as mandatory, the
alternative scheme is no longer supported.</p>
</div>
<div class="section" id="qm-mm-set-up-treatment-of-energy-terms">
<h3>QM/MM set-up: treatment of energy terms<a class="headerlink" href="#qm-mm-set-up-treatment-of-energy-terms" title="Permalink to this headline">¶</a></h3>
<p>The following directives control how different energy terms generated by
TINKER are taken into account in the QM/MM calculation.</p>
<p><code class="docutils literal"><span class="pre">tinker_bond_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the valence MM term due to bond stretches is included
in the QM/MM energy expression. When omitted, defaults to <code class="docutils literal"><span class="pre">0</span></code>. In
typical scenarios you’d want this enabled. Disabling might be necessary
if there are no bonds between MM atoms (e.g.&nbsp;for a noble gas).</p>
<p><code class="docutils literal"><span class="pre">tinker_angle_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the valence MM term due to angle bends is included in
the QM/MM energy expression. When omitted, defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical
scenarios you’d want this enabled. Disabling might be necessary if there
are no angles between MM atoms (e.g.&nbsp;for a noble or diatomic gas).</p>
<p><code class="docutils literal"><span class="pre">tinker_ureybrad_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the valence MM term due to Urey-Bradley interactions is
included in the QM/MM energy expression. When omitted, defaults to
<code class="docutils literal"><span class="pre">0</span></code>. In typical scenarios you’d want this enabled. Disabling might be
necessary if there are no Urey-Bradley interactions between MM atoms.</p>
<p><code class="docutils literal"><span class="pre">tinker_mm_perm_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the electrostatic term due to permanent MM-MM
interactions is included in the QM/MM energy expression. When omitted,
defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical scenarios you’d want this enabled.</p>
<p><code class="docutils literal"><span class="pre">tinker_mm_pol_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the electrostatic term due to MM-MM polarisation
interactions is included in the QM/MM energy expression. Even though
polarisation interactions are not additive, TINKER formally splits them
<em>a posteriori</em> into QM-MM polarisation and MM-MM polarisation, which add
up to total MM polarisation. When omitted, defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical
scenarios you’d want this enabled.</p>
<p><code class="docutils literal"><span class="pre">tinker_qm_mm_perm_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> –
when enabled (<code class="docutils literal"><span class="pre">1</span></code>), the electrostatic term due to interactions between
permanent MM multipoles and QM is included in the QM/MM energy
expression. When omitted, defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical scenarios you’d
want this <strong>disabled</strong>, because TINKER’s idea of this interaction
suffers from charge-penetration error. This term would then be taken
into account on ONETEP’s side, via an <code class="docutils literal"><span class="pre">energy_from_potential</span></code>
setting for permanent multipoles (cf.&nbsp;<code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code>).</p>
<p><code class="docutils literal"><span class="pre">tinker_qm_mm_pol_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the electrostatic term due to QM-MM polarisation
interactions is included in the QM/MM energy expression. Even though
polarisation interactions are not additive, TINKER formally splits them
<em>a posteriori</em> into QM-MM polarisation and MM-MM polarisation, which add
up to total MM polarisation. When omitted, defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical
scenarios you’d want this <strong>disabled</strong>. This term would then be taken
into account on ONETEP’s side, via an <code class="docutils literal"><span class="pre">energy_from_potential</span></code>
setting for induced dipoles (cf.&nbsp;<code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>). The two
expressions should yield the same result, provided <code class="docutils literal"><span class="pre">qmstar</span></code> is used
for <code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>. Having ONETEP calculate this term
permits checking the two results (TINKER’s and ONETEP’s) for
consistency.</p>
<p><code class="docutils literal"><span class="pre">tinker_mm_vdw_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1)</span></code> <strong>[optional, intermediate]</strong> – when
enabled (<code class="docutils literal"><span class="pre">1</span></code>), the van der Waals term due to MM-MM non-bonded
interactions is included in the QM/MM energy expression. When omitted,
defaults to <code class="docutils literal"><span class="pre">0</span></code>. In typical scenarios you’d want this enabled.</p>
<p><code class="docutils literal"><span class="pre">tinker_mm_vdw_energy</span> <span class="pre">(0</span> <span class="pre">or</span> <span class="pre">1</span> <span class="pre">or</span> <span class="pre">2</span> <span class="pre">or</span> <span class="pre">3)</span></code> <strong>[mandatory,
intermediate]</strong> – controls if and how the van der Waals term due to
QM-MM non-bonded interactions is included in the QM/MM energy
expression. The following values are possible:</p>
<ul class="simple">
<li>0 – omit QM-MM vdW interactions entirely.</li>
<li>1 – include QM-MM vdW interactions, both the repulsive and dispersive
term, via classical Halgren potential. Recommended for TINKTEP1
model.</li>
<li>2 – include QM-MM vdW interactions, but only the dispersive term, via
classical Halgren potential. Recommended for TINKTEP2 model, where
repulsive QM-MM vdW interactions would be handled via a repulsive MM
potential.</li>
<li>3 – include QM-MM vdW interactions, but only the repulsive term, via
classical Halgren potential. Only included for completeness.</li>
</ul>
</div>
<div class="section" id="qm-mm-set-up-details-of-the-interface">
<h3>QM/MM set-up: details of the interface<a class="headerlink" href="#qm-mm-set-up-details-of-the-interface" title="Permalink to this headline">¶</a></h3>
<p>The following directives control how the QM/MM interface behaves.</p>
<p><code class="docutils literal"><span class="pre">qm_mm_polscal</span> <span class="pre">(real)</span></code> <strong>[optional, intermediate]</strong> – controls scaling
of QM/MM polarisation interactions (introduced in TINKTEP2). Defaults to
no scaling if omitted. The apparent polarisability of QM sites is scaled
(multiplied) by the value of this parameter, thereby increasing damping
if it is greater than 1.0, and attenuating damping (increasing the
strength of polarisation interactions) if it is between 0.0 and 1.0.
Recommended value: 6.0 for TINKTEP2, omit for TINKTEP1.</p>
<p><code class="docutils literal"><span class="pre">renumber_offset</span> <span class="pre">(integer)</span></code> <strong>[mandatory, intermediate]</strong> – specifies
the value by which atom types for QM atoms are offset from their
original force field counterparts. This is used to avoid clashes between
“fake” QM types presented to TINKER and original atom types. Use a
large, three-digit value, like 500, unless you have good reason for
doing otherwise.</p>
<p><code class="docutils literal"><span class="pre">coord_xlat</span> <span class="pre">(x)</span> <span class="pre">(y)</span> <span class="pre">(z)</span></code> <strong>[optional, intermediate]</strong> – specifies the
vector (in bohr) by which all QM atoms are translated in the <code class="docutils literal"><span class="pre">.dat</span></code>
file. All arguments are real numbers and are mandatory. Values will be
interpreted as bohr, do not specify any units. This directive becomes
useful when the contents of the <em>qm.xyz</em> file are positioned unsuitably
for ONETEP in OBC mode, e.g.&nbsp;leading to NGWFs not fitting in the
simulation cell. In general, TINKER always works with original
(untranslated) coordinates, and ONETEP always sees coordinates
translated by this vector. All <code class="docutils literal"><span class="pre">.xyz</span></code> files work with the original
coordinates, the <code class="docutils literal"><span class="pre">.dat</span></code> file works with the translated coordinates. If
omitted, this value will be determined automatically: a bounding box
will be calculated for the QM subsystem, and the translation vector will
be such that the centre of the bounding box will coincide with the
centre of the simulation cell. This is handy, but can lead to eggbox
errors when comparing energies between different molecules (as they
might be translated differently). It is advised to set this translation
vector manually, and identically for all molecules whose energies will
be compared.</p>
</div>
<div class="section" id="qm-mm-set-up-expert-options">
<h3>QM/MM set-up: expert options<a class="headerlink" href="#qm-mm-set-up-expert-options" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">classical_atoms</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, expert]</strong> – when present,
TINKTEP will add a <code class="docutils literal"><span class="pre">%block</span> <span class="pre">classical_info</span></code> containing the species and
positions of MM atoms inferred from the <code class="docutils literal"><span class="pre">.xyz</span></code> and <code class="docutils literal"><span class="pre">.tag</span></code> files,
suitably translated, to the <code class="docutils literal"><span class="pre">.dat</span></code> file. Charges for the classical
atoms will be extracted from specially crafted comments in the
<code class="docutils literal"><span class="pre">.dat.template</span></code> file. This is useful when generating reference
classical embedding (“sparkles”) calculations. You should normally omit
this directive. The format for specifying charges of classical atoms is
as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>!$ classical_species_charge H 0.417
!$ classical_species_charge O -0.834
</pre></div>
</div>
<p>These lines are formally comments and will be ignored by ONETEP, but
<code class="docutils literal"><span class="pre">qm_xyz_to_dat</span></code> will know how to interpret them.</p>
<p><code class="docutils literal"><span class="pre">mm_fixed_charge</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, expert]</strong> – when present,
instructs TINKTEP that the MM force field is not polarisable. Leave this
directive out by default. Non-polarisable force-fields need a few
particular tweaks (TINKER’s <code class="docutils literal"><span class="pre">multipole</span></code> keyword is replaced by
<code class="docutils literal"><span class="pre">charge</span></code> in the <code class="docutils literal"><span class="pre">qm_mm.key</span></code> file, the <code class="docutils literal"><span class="pre">polarizable</span></code> keyword needs
to be omitted from same, <code class="docutils literal"><span class="pre">pol_emb_fixed_charge</span> <span class="pre">T</span></code> will be
automatically added to the <code class="docutils literal"><span class="pre">.dat</span></code> file to instruct ONETEP not to look
for <code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code> in the <code class="docutils literal"><span class="pre">.dat</span></code> file, and
TINKER’s output will be parsed differently). These tweaks are
activated by this directive.</p>
<p><code class="docutils literal"><span class="pre">pure_mm</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, expert]</strong> – when present, instructs
TINKTEP that the calculation is a purely MM calculation, and ONETEP does
not need to be invoked.</p>
<p><code class="docutils literal"><span class="pre">pure_qm</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, expert]</strong> – when present, instructs
TINKTEP that the calculation is a purely QM calculation: TINKTEP does
not need to be invoked, and <code class="docutils literal"><span class="pre">pol_emb_pot_filename</span> <span class="pre">T</span></code> must <strong>not</strong> be
added to the <code class="docutils literal"><span class="pre">.dat</span></code> file so that ONETEP runs without polarisable
embedding. This is necessary due to a bug in TINKER, which causes it to
hang if all atoms are inactive.</p>
<p><code class="docutils literal"><span class="pre">qm_mm_thole_a</span> <span class="pre">(real)</span></code> <strong>[optional, expert]</strong> – when present, the
specified value overrides the value of Thole’s <span class="math">\(a\)</span> parameter read
from the <code class="docutils literal"><span class="pre">.prm</span></code> file. This value will be used <em>only</em> for QM/MM
interactions, as TINKER will use the force-field value for MM/MM
interactions.</p>
<p><code class="docutils literal"><span class="pre">qm_dummy_atoms</span> <span class="pre">(no</span> <span class="pre">args)</span></code> <strong>[optional, expert]</strong> – experimental
functionality for adding dummy DMA sites on MM atoms, do not use.</p>
</div>
<div class="section" id="command-line-options-to-the-tinktep-script">
<h3>Command-line options to the tinktep script<a class="headerlink" href="#command-line-options-to-the-tinktep-script" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">tinktep</span></code> is normally run without arguments. The following
command-line options are supported:</p>
<p><code class="docutils literal"><span class="pre">-1</span></code> – Only the first two stages described in Section [running] are
performed, then TINKTEP exits. In essence, all input files are parsed
and intermediate inputs are prepared, but neither ONETEP nor TINKER are
actually run.</p>
<p><code class="docutils literal"><span class="pre">-2</span></code> – All stages described in Section [running], <em>except</em> the first
two, are performed. In essence, the calculation is run, assuming all
intermediate inputs have been prepared in advance. Splitting the two
parts of the calculation (preparation and actual execution) enables
manual or scripted tweaking of intermediate inputs by the user.</p>
<p><code class="docutils literal"><span class="pre">–dry-run</span></code> – equivalent to <code class="docutils literal"><span class="pre">-1</span></code>, only deprecated.</p>
</div>
</div>
<div class="section" id="onetep-keywords-pertaining-to-polarisable-embedding">
<h2>ONETEP keywords pertaining to polarisable embedding<a class="headerlink" href="#onetep-keywords-pertaining-to-polarisable-embedding" title="Permalink to this headline">¶</a></h2>
<p>A number of ONETEP keywords can be used to control the polarisable
embedding functionality, which underlies QM/MM calculations.</p>
<div class="section" id="keywords-mandatory-for-polarisable-embedding">
<h3>Keywords mandatory for polarisable embedding<a class="headerlink" href="#keywords-mandatory-for-polarisable-embedding" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">pol_emb_pot_filename</span> <span class="pre">(string)</span></code> – specifies the name of the file used
for exchanging information between ONETEP and TINKTEP. This file will be
read by ONETEP and constructed by TINKTEP at every energy evaluation.
This keyword is also used to turn on polarisable embedding (when it is
present), and to turn it off (when it is absent). Default: absent.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_dma_max_l</span> <span class="pre">(integer)</span></code> – specifies the maximum angular momentum
in the SW basis used in polarisable-embedding-DMA. In most scenarios
this will be equal to <span class="math">\(l_{\textrm{max}}\)</span> that you specified in the
SWRI block. Read the description of <span class="math">\(l_{\textrm{max}}\)</span> in the DMA
documentation to understand the meaning of this parameter. You can use a
lower value than the one specified in the SWRI block if you want to use
only a subset of the SW basis set (e.g.&nbsp;for benchmarking). This keyword
does not affect properties-DMA (for which <code class="docutils literal"><span class="pre">dma_max_l</span></code> should be used).
This directly affects the quality of the QM<span class="math">\(^*\)</span> representation –
specifying 0 leads to a charge-only representation, specifying 1 leads
to a charge-and-dipole representation, specifying 2 leads to a
charge-dipole-and-quadrupole representation.</p>
</div>
<div class="section" id="common-optional-keywords">
<h3>Common optional keywords<a class="headerlink" href="#common-optional-keywords" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">pol_emb_polscal</span> <span class="pre">(real)</span></code> – specifies the scaling factor applied to QM
polarisabilities (cf.&nbsp;<code class="docutils literal"><span class="pre">qm_mm_polscal</span></code> <code class="docutils literal"><span class="pre">tinktep.config</span></code> directive).
This keyword will be added automatically by TINKTEP, do not add it on
your own. Default: 1.0.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_repulsive_mm_pot_cutoff</span> <span class="pre">(physical)</span></code> – specifies the cutoff
(in length units) for the MM repulsive potential (cf.&nbsp;<code class="docutils literal"><span class="pre">rep</span></code> token in
<code class="docutils literal"><span class="pre">tinktep.config</span></code> directives <code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code> and
<code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>). The value of the MM repulsive potential
from an MM site will be assumed to be zero beyond this cutoff. This is
used to minimise computational effort. The default is 10.0 bohr.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_mpole_exclusion_radius</span> <span class="pre">(physical)</span></code> – specifies the distance
(in length units) around any multipole below which its Coulombic
potential is masked or smeared (cf.&nbsp;<code class="docutils literal"><span class="pre">potential_coulombic_masked</span></code> and
<code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code> arguments to <code class="docutils literal"><span class="pre">tinktep.config</span></code>
directives <code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code> and <code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>. This
has no effect on Thole-damped multipole sets. The default is 0.25 bohr.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_fixed_charge</span> <span class="pre">(logical)</span></code> – if <code class="docutils literal"><span class="pre">T</span></code>, the MM force field will
be assumed to be non-polarisable. If <code class="docutils literal"><span class="pre">F</span></code> (which is the default), the
MM force field will be assumed to be polarisable. When the force field
is polarisable and the QM<span class="math">\(^*\)</span> representation is used
(<code class="docutils literal"><span class="pre">pol_emb_qmstar</span> <span class="pre">T</span></code>), <code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code> becomes
mandatory. This keyword will be added automatically by TINKTEP, do not
add it on your own.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_qmstar</span> <span class="pre">(logical)</span></code> – if <code class="docutils literal"><span class="pre">T</span></code>, the QM<span class="math">\(^*\)</span>
representation will be employed for some or all QM-MM interactions. This
is automatically set to <code class="docutils literal"><span class="pre">T</span></code> once polarisable embedding is activated.
Only use <code class="docutils literal"><span class="pre">F</span></code> in the rare scenario, where the QM<span class="math">\(^*\)</span>
representation will not be necessary (e.g. for non-polarisable force
fields) and you want to elide <code class="docutils literal"><span class="pre">%block</span> <span class="pre">thole_polarisabilities</span></code>.</p>
</div>
<div class="section" id="uncommon-and-expert-optional-keywords">
<h3>Uncommon and expert optional keywords<a class="headerlink" href="#uncommon-and-expert-optional-keywords" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">pol_emb_thole_a</span> <span class="pre">(real)</span></code> – can be used to override the value of
Thole’s <span class="math">\(a\)</span> parameter read from the <code class="docutils literal"><span class="pre">.prm</span></code> file. This value will
be used <em>only</em> for QM/MM interactions, as TINKER will use the
force-field value for MM/MM interactions. This keyword will be added
automatically by TINKTEP if <code class="docutils literal"><span class="pre">qm_mm_thole_a</span></code> is specified in
<code class="docutils literal"><span class="pre">tinktep.config</span></code>, do not add it on your own. Default: 0.39.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_smearing_a</span> <span class="pre">(physical)</span></code> – can be used to control the
aggresiveness of Coulombic smearing (cf. <code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code>
argument to <code class="docutils literal"><span class="pre">tinktep.config</span></code> directives <code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code> and
<code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>. This has no effect on Thole-damped multipole
sets. The default is 0.2 bohr.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_pairwise_polarisability</span> <span class="pre">(physical)</span></code> – see discussion of
<code class="docutils literal"><span class="pre">potential_coulombic_smeared</span></code> argument to <code class="docutils literal"><span class="pre">tinktep.config</span></code>
directives <code class="docutils literal"><span class="pre">onetep_perm_mpoles</span></code> and <code class="docutils literal"><span class="pre">onetep_induced_dipoles</span></code>.
Default: 1.92618 bohr (yields the average AMOEBA09 polarisability). You
should not have to use this keyword.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_repulsive_mm_pot_write</span> <span class="pre">(logical)</span></code> – if set to <code class="docutils literal"><span class="pre">T</span></code>, the
repulsive MM potential will be written to a <code class="docutils literal"><span class="pre">.cube</span></code>/<code class="docutils literal"><span class="pre">.dx</span></code>/<code class="docutils literal"><span class="pre">.grd</span></code>
file at every energy evaluation. Used for debugging purposes. Default:
<code class="docutils literal"><span class="pre">F</span></code>.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_dbl_grid</span> <span class="pre">(logical)</span></code> – if set to <code class="docutils literal"><span class="pre">T</span></code> the polarisable
embedding contribution to the NGWF gradient will be computed on the
double grid. By default it is computed on the coarse grid, like in HFx.
Technically, to prevent aliasing, the double grid version should be
used, but it is unbearably inefficient and has not been optimised much,
as I plan this to remain an experimental facility at most. To ensure
consistency, <code class="docutils literal"><span class="pre">pol_emb_dbl_grid</span> <span class="pre">T</span></code> should only be used together with
<code class="docutils literal"><span class="pre">swx_dbl_grid</span> <span class="pre">T</span></code>, which ensures NGWF-SWOP overlaps are calculated on
the double grid too. This functionality has not been thoroughly tested.
I strongly recommend leaving this at default (<code class="docutils literal"><span class="pre">F</span></code>).</p>
<p><code class="docutils literal"><span class="pre">pol_emb_perm_scaling</span> <span class="pre">(real)</span></code> – all QM permanent multipoles will be
scaled by this factor (default: 1.0, so no scaling). This can be used to
test the effects of overpolarising/underpolarising QM/MM interactions.</p>
</div>
<div class="section" id="experimental-vacuum-dma-functionality">
<h3>Experimental vacuum-DMA functionality<a class="headerlink" href="#experimental-vacuum-dma-functionality" title="Permalink to this headline">¶</a></h3>
<p>This is an experimental, unpublished and hardly-tested functionality
that allows having two different QM<span class="math">\(^*\)</span> descriptions – one for
the vacuum density (i.e.&nbsp;in the absence of polarisable embedding), and
one for the difference between the density with embedding present and
without it (“polarisation density”). In principle this permits expanding
the vacuum state density e.g.&nbsp;up to quadrupoles, and the difference
e.g.&nbsp;only in dipoles, to mimic AMOEBA (by excluding “polarisable
quadrupoles” and “fluctuating charges” in QM). Preliminary tests (2017)
showed that this hardly matters, but it might be worth studying in more
detail.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_vacuum_qmstar</span> <span class="pre">(logical)</span></code> – when set to <code class="docutils literal"><span class="pre">T</span></code>, it enables the
vacuum-DMA functionality. Default: <code class="docutils literal"><span class="pre">F</span></code>, unless (all three
simultaneously) <code class="docutils literal"><span class="pre">pol_emb_write_vacuum_restart</span> <span class="pre">F</span></code>,
<code class="docutils literal"><span class="pre">pol_emb_vacuum_dma_max_l</span></code> is present and <code class="docutils literal"><span class="pre">pol_emb_qmstar</span> <span class="pre">T</span></code>.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_dma_min_l</span> <span class="pre">(integer)</span></code> – specifies the minimum angular momentum
in the SW basis used in polarisable-embedding-DMA <em>for the polarisation
density</em>. In most scenarios this will be equal to 0. This keyword does
not affect properties-DMA (for which the corresponding value is always
0). This directly affects the quality of the QM<span class="math">\(^*\)</span>
representation <em>for the polarisation density</em>. Setting
<code class="docutils literal"><span class="pre">pol_emb_dma_min_l</span> <span class="pre">1</span></code> and <code class="docutils literal"><span class="pre">pol_emb_dma_max_l</span> <span class="pre">1</span></code> in particular will
cause the polarisation density to be expanded only in terms of dipoles.
Default: 0.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_vacuum_dma_min_l</span> <span class="pre">(integer)</span></code> – specifies the minimum angular
momentum in the SW basis used in polarisable-embedding-DMA <em>for the
in-vacuum density</em>. In most scenarios this will be equal to 0. This
keyword does not affect properties-DMA (for which the corresponding
value is always 0). This directly affects the quality of the
QM<span class="math">\(^*\)</span> representation <em>for the in-vacuum density</em>. Default: 0.</p>
<p><code class="docutils literal"><span class="pre">pol_emb_vacuum_dma_max_l</span> <span class="pre">(integer)</span></code> – specifies the maximum angular
momentum in the SW basis used in polarisable-embedding-DMA <em>for the
in-vacuum density</em>. In most scenarios this will be equal to 1 (up to
dipoles) or 2 (up to quadrupoles). This keyword does not affect
properties-DMA (for which <code class="docutils literal"><span class="pre">dma_max_l</span></code> should be used). This directly
affects the quality of the QM<span class="math">\(^*\)</span> representation <em>for the
in-vacuum density</em>. Default: -1 (indicating “unset”).</p>
<p><code class="docutils literal"><span class="pre">pol_emb_write_vacuum_restart</span> <span class="pre">(logical)</span></code> – if set to <code class="docutils literal"><span class="pre">T</span></code>, restart
files (<code class="docutils literal"><span class="pre">.pol_emb_vac_tightbox_ngwfs</span></code> and <code class="docutils literal"><span class="pre">.pol_emb_kdenskern</span></code>) will
be written every time the NGWF gradient is calculated. These restart
files can be later used in the polarisation calculation. Default: <code class="docutils literal"><span class="pre">F</span></code></p>
</div>
<div class="section" id="block-keywords-used-in-polarisable-embedding">
<h3>Block keywords used in polarisable embedding<a class="headerlink" href="#block-keywords-used-in-polarisable-embedding" title="Permalink to this headline">¶</a></h3>
<p>The following blocks are used to control polarisable embedding in
ONETEP:</p>
<ul>
<li><div class="first highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">block</span> <span class="n">thole_polarisabilities</span>
<span class="o">&lt;</span><span class="n">QMatom1</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">polarisability1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">QMatom2</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">polarisability2</span><span class="o">&gt;</span>
<span class="o">...</span>        <span class="o">...</span>
<span class="o">&lt;</span><span class="n">QMatom</span><span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;&gt;</span> <span class="o">&lt;</span><span class="n">polarisability</span><span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;&gt;</span>
<span class="o">%</span><span class="n">endblock</span> <span class="n">thole_polarisabilities</span>
</pre></div>
</div>
<p>This block specifies Thole polarisabilities for all QM atoms, in
units of bohr<span class="math">\(^3\)</span>. Normally (i.e.&nbsp;if
<code class="docutils literal"><span class="pre">qm_thole_polarisability</span></code> is specified in <code class="docutils literal"><span class="pre">tinktep.config</span></code>), this
block will be automatically added by TINKTEP, which infers the QM
polarisabilities from the <code class="docutils literal"><span class="pre">.prm</span></code> and <code class="docutils literal"><span class="pre">.tag</span></code> files. If you prefer
to specify polarisabilities manually, add this block and omit
<code class="docutils literal"><span class="pre">qm_thole_polarisability</span></code> from <code class="docutils literal"><span class="pre">tinktep.config</span></code>. For example for
water TINKTEP would generate:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>%block thole_polarisabilities
O 5.648355971436 ! Water O
H 3.347173908999 ! Water H
H 3.347173908999 ! Water H
%endblock thole_polarisabilities
</pre></div>
</div>
</li>
<li><div class="first highlight-default"><div class="highlight"><pre><span></span>%block mm_rep_params
&lt;MMspecies1&gt; &lt;A!1&gt; &lt;zeta1&gt;
&lt;MMspecies2&gt; &lt;A!2&gt; &lt;zeta2&gt;
...        ...
&lt;MMspecies&lt;n&gt;&gt; &lt;A!&lt;n&gt;&gt; &lt;zeta&lt;n&gt;&gt;
%endblock mm_rep_params
</pre></div>
</div>
<p>This block specifies the MM repulsive potential parameters for all MM
species in the system. The parameter <span class="math">\(A\)</span> is the magnitude (in
hartree), the parameter zeta=<span class="math">\(\zeta\)</span> is the inverse-width (in
bohr<span class="math">\(^{-1}\)</span>). For example for water, parameterised as in
Ref. [Dziedzic2018]:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">block</span> <span class="n">mm_rep_params</span>
<span class="n">H</span>   <span class="mi">35</span> <span class="mf">2.400</span>
<span class="n">O</span>  <span class="mi">550</span> <span class="mf">1.580</span>
<span class="o">%</span><span class="n">endblock</span> <span class="n">mm_rep_params</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="questions">
<h2>Questions?<a class="headerlink" href="#questions" title="Permalink to this headline">¶</a></h2>
<p>Questions should be directed to Jacek Dziedzic,
<code class="docutils literal"><span class="pre">J.Dziedzic[-at-]soton.ac.uk.</span></code></p>
<p>[Stone1998] A.J. Stone, GDMA: distributed multipoles from Gaussian98 wavefunctions (technical report), University of Cambridge (1998).</p>
<p>[Stone2005] A.J. Stone, Journal of Chemical Theory and Computation <strong>6</strong> 1128-1132 (2005).</p>
<p>[Dziedzic2016] J. Dziedzic, Y. Mao, Y. Shao, J. Ponder, T. Head-Gordon, M. Head-Gordon and C.-K. Skylaris, J. Chem. Phys. <strong>145</strong> 12 124106 (2016).</p>
<p>[Dziedzic2018] J. Dziedzic, T. Head-Gordon, M. Head-Gordon and C.-K. Skylaris, (in preparation) (2018).</p>
<p>[Vitale2015] V. Vitale, J. Dziedzic, S.M.-M. Dubois, H. Fangohr and C.-K. Skylaris, Journal of Chemical Theory and Computation <strong>11</strong> 7 3321-3332 (2015).</p>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[1]</a></td><td>Except for purely QM calculations.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="index_qmmm.html">QM/MM (TINKTEP) and Polarisable Embedding</a><ul>
      <li>Previous: <a href="index_qmmm.html" title="previous chapter">QM/MM (TINKTEP) and Polarisable Embedding</a></li>
      <li>Next: <a href="index_properties.html" title="next chapter">Properties</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Joseph Prentice.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/tinktep.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
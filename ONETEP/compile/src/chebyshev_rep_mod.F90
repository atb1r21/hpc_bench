! -*- mode: F90 ; mode: font-lock ; column-number-mode: true -*-
!-----------------------------------------------------------------------!
!                                                                       !
! Chebyshev representation module                                       !
!                                                                       !
! Written by Jacek Dziedzic in January 2012                             !
!                                                                       !
! Generalized by James C. Womack to support both 2-D and 3-D            !
! Chebyshev expansions in 2018                                          !
!                                                                       !
!-----------------------------------------------------------------------!
!                                                                       !
! This module implements expansion of functions into Chebyshev          !
! polynomials. The expansions can then be easily and efficiently        !
! integrated. This is especially handy for integrals of products --     !
! in order to obtain \int f1_i(x) f2_j(x) dx for i=1..M, j=1..N,        !
! it suffices to expand f1_i(x) for i=1..M and f2_j(x) for j=1..N       !
! (at a cost of O(M+N)), followed by integrating the product of the     !
! expansions, which, although still O(M*N), has a much smaller prefactor!
! as products of Chebyshev polynomials can be accurately and efficiently!
! integrated.                                                           !
!                                                                       !
! The module currently implements this for 1D integrals, for 2D         !
! integrals on a disc (or half-disc) and for 3D integrals over a sphere.!
! The expansion is performed on a given number of intervals to prevent  !
! Runge's phenomenon that plagues high-order expansions. Thus it is     !
! possible to expand a function over, say, 10 intervals with 8th order  !
! Chebyshev polynomials.                                                !
!                                                                       !
!-----------------------------------------------------------------------!


module chebyshev_rep

  use constants, only: DP
  use utils, only: utils_trace_in, utils_trace_out

  implicit none
  private

  public :: CHEB_RANGES
  public :: CHEB_NODES
  public :: CHEB_COEFFS
  public :: HANDLE_SET

  ! Public subroutines

  ! --- single-interval, 1D expansion ---
  public :: cheb_gen_nodes_1D
  public :: cheb_expansion_1D
  public :: cheb_int_1D
  public :: cheb_int_product_1D

  ! --- many-interval (piecewise), 1D expansion ---
  public :: cheb_gen_nodes_piecewise_1D
  public :: cheb_expansion_piecewise_1D
  public :: cheb_int_piecewise_1D
  public :: cheb_int_product_piecewise_1D

  ! --- Expansion over 2D (disc) or 3D (sphere) ---
  public :: cheb_gen_nodes_piecewise_nD
  public :: cheb_expansion_piecewise_nD
  public :: cheb_int_sphere
  public :: cheb_int_product_piecewise_nD

  ! --- Allocation and deallocation of coefficients ---
  public :: cheb_alloc_coeffs
  public :: cheb_dealloc_coeffs

  ! --- Interprocessor communication of coefficients ---
  public :: cheb_send_coeffs_initiate
  public :: cheb_recv_coeffs_initiate
  public :: cheb_test_completion

  ! --- Public constants ---
  public :: CHEB_COEFFS_ARE_NULL ! used when all coefficient in a *sphere* are 0

  ! ---------------------------------------------------------------------------

  ! Stores ranges of component integrals in a 3D sphere expansion
  ! JCW: Stores ranges of component integrals in a 2D (disc) or
  ! JCW: 3D (sphere) expansion
  type CHEB_RANGES
     integer :: n_stripes(3) ! Stripes along x (1), y (2), z (3) directions
     real(kind=DP) :: zmin
     real(kind=DP) :: zmax
     real(kind=DP), allocatable :: ymin(:)
     real(kind=DP), allocatable :: ymax(:)
     real(kind=DP), allocatable :: xmin(:,:)
     real(kind=DP), allocatable :: xmax(:,:)
  end type CHEB_RANGES

  ! JCW: Stores Chebyshev nodes in a 2D (disc) or 3D (sphere)
  ! JCW: expansion
  type CHEB_NODES
     integer :: n_dim ! JCW: Dimensions (1: line, 2: disc, 3: sphere)
     integer :: n_points_total
     type(CHEB_RANGES) :: ranges
     real(kind=DP), allocatable :: znodes(:)
     real(kind=DP), allocatable :: ynodes(:,:)
     real(kind=DP), allocatable :: xnodes(:,:,:)
  end type CHEB_NODES

  integer, parameter :: CHEB_COEFFS_ARE_NULL = -1
  integer, parameter :: CHEB_COEFFS_ARE_INVALID = -2
  ! Used when all coefficients in a cross-section through a sphere are zero
  real(kind=DP), parameter :: CHEB_SECTION_ALL_ZERO = 123456.7890123_DP

  ! JCW: Stores Chebyshev expansion coefficients for a 2D (disc) or
  ! JCW: 3D (sphere) expansion
  ! NB, any additions to this structure require updates to
  !     cheb_send_coeffs_initiate and cheb_recv_coeffs_initiate, and updating
  !     n_variables_in_sphere_coeffs.
  ! NB, n_intervals == CHEB_COEFFS_ARE_NULL means
  !                    expansion is zero everywhere, but memory still allocated.
  ! NB, n_intervals == CHEB_COEFFS_ARE_INVALID means
  !                    expansion no longer valid, memory deallocated.
  type CHEB_COEFFS
     integer :: n_dim ! JCW: Dimensions (1: line, 2: disc, 3: sphere)
     integer :: n_intervals
     integer :: order
     real(kind=DP), allocatable :: xcoeffs(:,:,:)
  end type CHEB_COEFFS
  integer, parameter :: n_variables_in_cheb_coeffs = 3
  ! JCW: --> This is 3, even though there are 4 variables in CHEB_COEFFS
  ! JCW:     since the (presently unused) cheb_*_coeffs_initiate routines have
  ! JCW:     not been updated to support n_dim /= 3 or send/recv
  ! JCW:     CHEB_COEFFS%n_dim. If these routines are updated to support
  ! JCW:     additional components of CHEB_COEFFS, then
  ! JCW:     n_variables_in_cheb_coeffs should be updated to reflect this.

  ! An opaque type for testing for completion of cheb_*_coeffs_initiate
  type HANDLE_SET
     integer :: handles(1:n_variables_in_cheb_coeffs)
  end type

  integer, parameter :: CHEB_ELEMENT_TAG = 900 ! Internal

  integer, parameter :: max_cheb_order = 40
  real(kind=DP) :: cheb_integrals(max_cheb_order)

  ! Table of integrals of (ChebyshevT[n,1] - ChebyshevT[n,-1])
  DATA cheb_integrals(:) / &
       2.0000000000000000000000000_DP,   0.0_DP, &
      -0.6666666666666666666666667_DP,   0.0_DP, &
      -0.13333333333333333333333333_DP,  0.0_DP, &
      -0.05714285714285714285714286_DP,  0.0_DP, &
      -0.03174603174603174603174603_DP,  0.0_DP, &
      -0.02020202020202020202020202_DP,  0.0_DP, &
      -0.01398601398601398601398601_DP,  0.0_DP, &
      -0.01025641025641025641025641_DP,  0.0_DP, &
      -0.007843137254901960784313725_DP, 0.0_DP, &
      -0.006191950464396284829721362_DP, 0.0_DP, &
      -0.005012531328320802005012531_DP, 0.0_DP, &
      -0.004140786749482401656314700_DP, 0.0_DP, &
      -0.003478260869565217391304348_DP, 0.0_DP, &
      -0.002962962962962962962962963_DP, 0.0_DP, &
      -0.002554278416347381864623244_DP, 0.0_DP, &
      -0.002224694104560622914349277_DP, 0.0_DP, &
      -0.001955034213098729227761486_DP, 0.0_DP, &
      -0.001731601731601731601731602_DP, 0.0_DP, &
      -0.001544401544401544401544402_DP, 0.0_DP, &
      -0.001386001386001386001386001_DP, 0.0_DP /

  real(kind=DP) :: cheb_product_integrals(max_cheb_order, max_cheb_order)
  ! jd: Let I_nm(x) = \int ChebyshevT[n,x] * ChebyshevT[m,x] dx
  !     The following is a table of I_nm(1) - I_nm(-1) for all n, m in [1, 40].
  !
  !     There are 35 digits of precision in case these subroutines are ever
  !     ported to quad precision.
  !
  !     It can be obtained by first running the following code in Mathematica
  !
  ! IntOfChebyshevT[n_, xx_] := ChebIntegralTable[[n + 1]] /. x -> xx
  ! IntOfChebyshevTProduct[n_, m_, xx_] :=
  ! ChebProductIntegralTable[[n + 1]][[m + 1]] /. x -> xx
  ! tabmax = 40;
  ! ChebIntegralTable = {}; ChebSquaredIntegralTable = {};
  ! ChebProductIntegralTable = Table[I, {i, 1, tabmax}, {j, 1, tabmax}];
  ! IntOfChebyshevTProductLookup = Table[I, {i, 1, tabmax}, {j, 1, tabmax}];
  ! For[n = 0, n < tabmax,
  !   AppendTo[ChebIntegralTable, Integrate[ChebyshevT[n, x], x]];
  !   AppendTo[ChebSquaredIntegralTable, Integrate[ChebyshevT[n, x]^2, x]];
  !   For[m = 0, m < tabmax,
  !     ChebProductIntegralTable[[n + 1]][[m + 1]] =
  !       Integrate[ChebyshevT[n, x]*ChebyshevT[m, x], x];
  !     IntOfChebyshevTProductLookup[[n + 1]][[m + 1]] =
  !       IntOfChebyshevTProduct[n, m, 1] - IntOfChebyshevTProduct[n, m, -1];
  !     m++;
  !   ];
  !   n++;
  ! ]
  ! Export["coeffs.txt", N[IntOfChebyshevTProductLookup, 35], "Table"]
  !
  ! The output in coeffs.txt should then be parsed with
  !
  ! cat coeffs.txt | awk -v max_cheb_order=40 '
  !     {
  !       printf("  DATA cheb_product_integrals(:,%d) / &\n",NR)
  !       for(i=1; i<=max_cheb_order-2; i+=2) {
  !         printf("       %+.35f_DP, %+.35f_DP, &\n",$i,$(i+1))
  !       }
  !       printf("       %+.35f_DP, %+.35f_DP\n",$i,$(i+1))
  !     }'
  !
  ! ... and pasted below

  DATA cheb_product_integrals(:,1) / &
       +2.00000000000000000000000000000000000_DP, +0.00000000000000000000000000000000000_DP, &
       -0.66666666666666662965923251249478199_DP, +0.00000000000000000000000000000000000_DP, &
       -0.13333333333333333148296162562473910_DP, +0.00000000000000000000000000000000000_DP, &
       -0.05714285714285714107285585328099842_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03174603174603174426948726249975152_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02020202020202020373740303682552621_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01398601398601398600185508058757478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01025641025641025640136039243088817_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00784313725490196067546833091910230_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00619195046439628520029696545634579_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00501253132832080172676114671048708_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00414078674948240195441417910160453_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00347826086956521752027726712697131_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00296296296296296281583271259307821_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00255427841634738202192256295575135_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00222469410456062289746514970545377_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00195503421309872922606576395310185_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00173160173160173160022967664417592_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00154440154440154439434429445299202_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00138600138600138600604438909869032_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,2) / &
       +0.00000000000000000000000000000000000_DP, +0.66666666666666662965923251249478199_DP, &
       +0.00000000000000000000000000000000000_DP, -0.40000000000000002220446049250313081_DP, &
       +0.00000000000000000000000000000000000_DP, -0.09523809523809523280846178749925457_DP, &
       +0.00000000000000000000000000000000000_DP, -0.04444444444444444614061850984398916_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02597402597402597573816862563944596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01709401709401709573699079669495404_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01212121212121212120160773650923147_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00904977375565610940577609966339878_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00701754385964912293788264818772404_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00560224089635854346352905608341644_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00457665903890160184058766290604581_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00380952380952380952050528861718703_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00322061191626409016805498986002476_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00275862068965517220203720327731389_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00238948626045400224285342183350167_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00208986415882967627860589132637870_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00184331797235023041314772029863889_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00163800163800163810570720279713441_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00146520146520146520019434177584117_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00131839156229400121175809879048302_DP /
  DATA cheb_product_integrals(:,3) / &
       -0.66666666666666662965923251249478199_DP, +0.00000000000000000000000000000000000_DP, &
       +0.93333333333333334813630699500208721_DP, +0.00000000000000000000000000000000000_DP, &
       -0.36190476190476189577438503874873277_DP, +0.00000000000000000000000000000000000_DP, &
       -0.08253968253968253787622444406224531_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03867243867243867067040596907645522_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02286602286602286773775638550887379_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01522921522921522920201997663980364_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01091457562045797420602344374174208_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00822418036040327080082867894361698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00642783429161138120111473881479469_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00516636860693934357735557227897516_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00424539609894300940667877242162831_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00355187485622268216828301135024049_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00301626964295629955425948054426044_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00259382853376179285664893114926599_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00225465631472305562399416345442660_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00197814791808117746568784767191573_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00174971787875013691862524645159738_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00155880155880155869471681562288268_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00139759164149408062274848596473475_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,4) / &
       +0.00000000000000000000000000000000000_DP, -0.40000000000000002220446049250313081_DP, &
       +0.00000000000000000000000000000000000_DP, +0.97142857142857141905523121749865822_DP, &
       +0.00000000000000000000000000000000000_DP, -0.34920634920634918696435988749726675_DP, &
       +0.00000000000000000000000000000000000_DP, -0.07676767676767676240601190329471137_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03556443556443556613944068089949724_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02100122100122100293750904143053049_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01402257872846108220643568387231426_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01008898222520513560107602302196028_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00763447079236552906406076957068763_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00599196200219218131494125501035342_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00483510566698075114344668179455766_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00398774714564188205445649515468176_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00334753258291489155448750203447617_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00285147748706292020887120841621254_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00245899858803084623778967277019092_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00214294007397455681107611979996364_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00188454782448108375432493932777334_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00167051779955005750763485927734564_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00149119173509417411727095981177627_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00133941574667609838815429679215185_DP /
  DATA cheb_product_integrals(:,5) / &
       -0.13333333333333333148296162562473910_DP, +0.00000000000000000000000000000000000_DP, &
       -0.36190476190476189577438503874873277_DP, +0.00000000000000000000000000000000000_DP, &
       +0.98412698412698407235410513749229722_DP, +0.00000000000000000000000000000000000_DP, &
       -0.34343434343434342537193515454418957_DP, +0.00000000000000000000000000000000000_DP, &
       -0.07365967365967365787504661511775339_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03369963369963369786974638486753975_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01979458450046685247247779670942691_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01319698533320824360148826315253245_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00949927265716739473166985163743448_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00719859850294632917788728576624635_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00566069906223358888103236452593592_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00457745671367962379122440452761111_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00378340487233409187434185483311921_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00318274042702151220909922990642826_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00271664754133197315633108104293569_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00234728234728234742487162911572796_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00204933998037446331655364595292212_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00180534774528100456017498665062249_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00160290797584267293018900346623923_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00143301584027619188267677063919336_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,6) / &
       +0.00000000000000000000000000000000000_DP, -0.09523809523809523280846178749925457_DP, &
       +0.00000000000000000000000000000000000_DP, -0.34920634920634918696435988749726675_DP, &
       +0.00000000000000000000000000000000000_DP, +0.98989898989898994496883233296102844_DP, &
       +0.00000000000000000000000000000000000_DP, -0.34032634032634034859654548199614510_DP, &
       +0.00000000000000000000000000000000000_DP, -0.07179487179487178960535231908579590_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03249299719887955434360904405366455_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01896899110521401560225385196645220_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01260727576517050273208209176800665_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00906340036774819397813462984458965_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00686733556298773674397839528182885_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00540305010893246152881008725898937_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00437311444037183361110976420604857_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00361861271644071252895358270507131_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00304791048129056559023997152735319_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00260493130058347434341303738847273_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00225368225368225349666828627448467_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00197013990117438390556325877867039_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00173773792157361976588869634241519_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00154473208102469069559481429365633_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00138259673143394080062351658710895_DP /
  DATA cheb_product_integrals(:,7) / &
       -0.05714285714285714107285585328099842_DP, +0.00000000000000000000000000000000000_DP, &
       -0.08253968253968253787622444406224531_DP, +0.00000000000000000000000000000000000_DP, &
       -0.34343434343434342537193515454418957_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99300699300699302174422200550907291_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33846153846153848032685118596418761_DP, +0.00000000000000000000000000000000000_DP, &
       -0.07058823529411764607921497827192070_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03166740380362671053449119540346146_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01837928153717627299812420460511930_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01217140347575130197854686997516183_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00873213742778960154422573936017216_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00660968660968660939175611801488230_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00519870783562467134869544693742682_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00420832228447845426572149207800067_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00348378277070976547641345533179447_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00293619424054206677732192787289023_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00251133120698338084889056354143122_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00217448217448217451935876809443471_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00190253007746699932811740296756398_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00167956202675563753129450716983229_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00149431297218243961354156024157191_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,8) / &
       +0.00000000000000000000000000000000000_DP, -0.04444444444444444614061850984398916_DP, &
       +0.00000000000000000000000000000000000_DP, -0.07676767676767676240601190329471137_DP, &
       +0.00000000000000000000000000000000000_DP, -0.34032634032634034859654548199614510_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99487179487179489001391630154103041_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33725490196078433680071384515031241_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06976264189886480227009712962171761_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03107769423558897139980849999574275_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01794340924775707224458898281227448_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01184014053579270954463797949074433_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00847448847448847505936520008162915_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00640534433637881921164147769331976_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00503391567973129200330717480937892_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00407349233874750721318136470472382_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00337206652996126666349541167733150_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00284259414694197284911858503164694_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00243213112778330187158104536138126_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00210687235077478994191291228332830_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00184435418264901709352321379498107_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00162914291791338644924125311774787_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00145033034532005022411438321938704_DP /
  DATA cheb_product_integrals(:,9) / &
       -0.03174603174603174426948726249975152_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03867243867243867067040596907645522_DP, +0.00000000000000000000000000000000000_DP, &
       -0.07365967365967365787504661511775339_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33846153846153848032685118596418761_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99607843137254903354005364235490561_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33642930856553149299159599650010932_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06917293233082706660486138616761309_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03064182194616977064627327820289793_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01761214630779848328012704428147117_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01158249158249158305977744021220133_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00827014620118068401188882177166306_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00624055218048543986625320556527186_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00489908573400034495076704743610208_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00396177609799900840026332105026086_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00327846643636117316897293783028999_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00276339406774189387180906685159698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00236452130407591686045432055607307_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00204869645595680749047828861364451_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00179393507380676579462952524579578_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00158516029105099705981407609556300_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,10) / &
       +0.00000000000000000000000000000000000_DP, -0.02597402597402597573816862563944596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03556443556443556613944068089949724_DP, &
       +0.00000000000000000000000000000000000_DP, -0.07179487179487178960535231908579590_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33725490196078433680071384515031241_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99690402476780182183802025974728167_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33583959899749371569299682960263453_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06873706004140786585132616437476827_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03031055900621118168181133967209462_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01735449735449735506054302902612108_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01137814930918379201230106190223523_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00810535404528730379913881165521161_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00610572223475449281371307819199501_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00478736949325184613784900378163911_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00386817600439891447205997820901757_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00319926635716109419166341965024003_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00269578424403450929436321104049057_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00230634540925793484270056588059106_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00199827734711455640842503456156010_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00174995244694437640520234822361090_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00154656329196767566153125628147791_DP /
  DATA cheb_product_integrals(:,11) / &
       -0.02020202020202020373740303682552621_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02286602286602286773775638550887379_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03369963369963369786974638486753975_DP, +0.00000000000000000000000000000000000_DP, &
       -0.07058823529411764607921497827192070_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33642930856553149299159599650010932_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99749373433583954362546819538692944_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33540372670807455657282503125315998_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06840579710144926994797032193673658_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03005291005291005346222732441674452_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01715015508118956227834317473934789_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01121335715329041179955105178578378_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00797052409955635761396042227033831_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00599400599400599400079503453753205_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00469376939965175220964566094039583_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00378897592519883549475046002896761_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00313165653345370918053669484493184_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00263760834921652684292858737080678_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00225592630041568376064731182850664_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00195429472025216701899785753937522_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00171135544786105522375996290662670_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,12) / &
       +0.00000000000000000000000000000000000_DP, -0.01709401709401709573699079669495404_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02100122100122100293750904143053049_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03249299719887955434360904405366455_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06976264189886480227009712962171761_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33583959899749371569299682960263453_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99792960662525875825679122499423102_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33507246376811594679168138100067154_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06814814814814815213672716254222905_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02984856777960226068002747012997133_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01698536292529618380031664059970353_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01107852720755946561437266240091049_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00785880785880785880104237861587535_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00590040590040590007259169169628876_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00461456932045167366601701175454764_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00372136610149145091730460421786120_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00307348063863572716278294016944983_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00258718924037427576087533331872237_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00221194367355329437122013480632177_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00191569772116884583755547222239102_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00167729927219930122737900912710529_DP /
  DATA cheb_product_integrals(:,13) / &
       -0.01398601398601398600185508058757478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01522921522921522920201997663980364_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01979458450046685247247779670942691_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03166740380362671053449119540346146_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06917293233082706660486138616761309_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33540372670807455657282503125315998_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99826086956521742354908610650454648_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33481481481481478734707479816279374_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06794380587484036282397426020907005_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02968377562370888220200093599032698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01685053297956523934986172719163733_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01096681096681096680145461874644752_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00776520776520776487283903577463207_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00582120582120582152896304251044057_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00454695949674428865489028694923945_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00366319020667346846586998054817741_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00302306152979347608072968611736542_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00254320661351188637144815629653749_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00217334667446997297293731499223668_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00188164154550709162433408394576873_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,14) / &
       +0.00000000000000000000000000000000000_DP, -0.01212121212121212120160773650923147_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01402257872846108220643568387231426_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01896899110521401560225385196645220_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03107769423558897139980849999574275_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06873706004140786585132616437476827_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33507246376811594679168138100067154_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99851851851851847197139022682677023_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33461047254150699803432189582963474_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06777901371894698434594772606942570_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02954894567797793775154602258226078_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01673881673881674053694368353717437_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01087321087321087287325127590520424_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00768600768600768632921038658878388_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00575359599749843651783631770513239_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00448878360192630620345566327955567_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00361277109783121738381672649609300_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00297907890293108669130250909518054_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00250460961442856497316533648245240_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00213929049880821897655636121271527_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00185144078595798899922186819821945_DP /
  DATA cheb_product_integrals(:,15) / &
       -0.01025641025641025640136039243088817_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01091457562045797420602344374174208_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01319698533320824360148826315253245_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01837928153717627299812420460511930_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03064182194616977064627327820289793_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06840579710144926994797032193673658_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33481481481481478734707479816279374_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99872286079182626128414312915992923_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33444568038561361955629536168999039_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06764418377321602948715195680051693_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02943722943722943893862797892779781_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01664521664521664487401686471912399_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01079401079401079432962262671935605_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00761839786230030131808366178347569_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00569542010268045406640169403544860_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00443836449308405555508327822167303_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00356878847096882799438954947390812_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00294048190384776529301968928109545_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00247055343876681097678438270293100_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00210908973925911635144414546516600_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,16) / &
       +0.00000000000000000000000000000000000_DP, -0.00904977375565610940577609966339878_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01008898222520513560107602302196028_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01260727576517050273208209176800665_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01794340924775707224458898281227448_DP, &
       +0.00000000000000000000000000000000000_DP, -0.03031055900621118168181133967209462_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06814814814814815213672716254222905_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33461047254150699803432189582963474_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99888765294771963976216966329957359_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33431085043988267857528740023553837_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06753246753246752720478696119243978_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02934362934362934327570116010974743_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01656601656601656633038821553327580_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01072640097030340931849590191404786_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00756022196748231886664903811379190_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00564500099383820341802930897756596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00439438186622166573197523220528637_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00353019147188550659610672965982303_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00290642572818601129663873550157405_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00244035267921770835167216695538173_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00208218360802446111196273292875958_DP /
  DATA cheb_product_integrals(:,17) / &
       -0.00784313725490196067546833091910230_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00822418036040327080082867894361698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00949927265716739473166985163743448_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01217140347575130197854686997516183_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01761214630779848328012704428147117_DP, +0.00000000000000000000000000000000000_DP, &
       -0.03005291005291005346222732441674452_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06794380587484036282397426020907005_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33444568038561361955629536168999039_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99902248289345063625432885601185262_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33419913419913421792628582807083149_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06743886743886744195020099823523196_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02926442926442926473207251092389924_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01649840674230918305398496670477471_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01066822507548542686706127824436408_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00750980285864006821827665305590926_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00560101836697581359492126296117931_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00435578486713834433369241239120129_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00349613529622375259972577588030163_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00287622496863690867152651975402478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00241344654798305311219075441897530_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,18) / &
       +0.00000000000000000000000000000000000_DP, -0.00701754385964912293788264818772404_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00763447079236552906406076957068763_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00906340036774819397813462984458965_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01184014053579270954463797949074433_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01735449735449735506054302902612108_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02984856777960226068002747012997133_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06777901371894698434594772606942570_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33431085043988267857528740023553837_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99913419913419909690333042817655951_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33410553410553411879391205729916692_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06735966735966736340657234904938377_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02919681944072188145566926209539815_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01644023084749119886782686705828382_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01061780596664317621868889318648144_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00746582023177767839516860703952261_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00556242136789249219663844314709422_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00432172869147659077099232760588166_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00346593453667464997461356013275235_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00284931883740225343204510721761835_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00238937264108888842290001619517170_DP /
  DATA cheb_product_integrals(:,19) / &
       -0.00619195046439628520029696545634579_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00642783429161138120111473881479469_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00719859850294632917788728576624635_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00873213742778960154422573936017216_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01158249158249158305977744021220133_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01715015508118956227834317473934789_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02968377562370888220200093599032698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06764418377321602948715195680051693_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33419913419913421792628582807083149_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99922779922779925154685543020605110_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33402633402633402637249560029886197_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06729205753595997319127519631365431_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02913864354590389726951116244890727_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01638981173864894821945448200040119_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01057382333978078639558084717009478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00742722323269435699688578722543753_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00552836519223073863393835836177459_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00429152793192748814588011185833238_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00343902840543999473513214759634593_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00282524493050808830907349999961298_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,20) / &
       +0.00000000000000000000000000000000000_DP, -0.00560224089635854346352905608341644_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00599196200219218131494125501035342_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00686733556298773674397839528182885_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00847448847448847505936520008162915_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01137814930918379201230106190223523_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01698536292529618380031664059970353_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02954894567797793775154602258226078_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06753246753246752720478696119243978_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33410553410553411879391205729916692_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99930699930699928845712065594852902_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33395872420262662227941063974867575_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06723388164114199594401100057439180_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02908822443706164662113877739102463_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01634582911178655839634643598401453_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01053522634069746499729802735600970_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00739316705703260343418570244011789_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00549816443268163600882614261422532_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00426462180069283290639869932192596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00341495449854582961216054037834056_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00280361921753536367032944021104868_DP /
  DATA cheb_product_integrals(:,21) / &
       -0.00501253132832080172676114671048708_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00516636860693934357735557227897516_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00566069906223358888103236452593592_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00660968660968660939175611801488230_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00827014620118068401188882177166306_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01121335715329041179955105178578378_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01685053297956523934986172719163733_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02943722943722943893862797892779781_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06743886743886744195020099823523196_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33402633402633402637249560029886197_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99937460913070663703905438524088822_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33390054830780868666550986745278351_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06718346253229974529563861551650916_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02904424181019925679803073137463798_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01630723211270323699806361616992945_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01050117016503571143459794257069007_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00736296629748350080907348669256862_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00547125830144698076934473007781889_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00424054789379866778342709210392059_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00339332878557310540709734958397803_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,22) / &
       +0.00000000000000000000000000000000000_DP, -0.00457665903890160184058766290604581_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00483510566698075114344668179455766_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00540305010893246152881008725898937_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00640534433637881921164147769331976_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00810535404528730379913881165521161_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01107852720755946561437266240091049_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01673881673881674053694368353717437_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02934362934362934327570116010974743_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06735966735966736340657234904938377_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33395872420262662227941063974867575_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99943278502552468367525762005243450_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33385012919896639438377405895153061_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06713947990543735200308361754650832_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02900564481111593539974791156055289_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01627317593704148343536353138460981_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01047096940548660794212398883473725_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00733606016624884556959207415616220_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00544718439455281564637312285981352_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00421892218082594357836390130955806_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00337383019190917341975644028195802_DP /
  DATA cheb_product_integrals(:,23) / &
       -0.00414078674948240195441417910160453_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00424539609894300940667877242162831_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00457745671367962379122440452761111_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00519870783562467134869544693742682_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00624055218048543986625320556527186_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00797052409955635761396042227033831_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01096681096681096680145461874644752_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01664521664521664487401686471912399_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02926442926442926473207251092389924_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06729205753595997319127519631365431_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33390054830780868666550986745278351_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99948320413436697595699342855368741_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33380614657210400109121906098152976_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06710088290635403407424774968603742_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02897158863545418183704782677523326_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01624297517749238167761305362546409_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01044406327425195270264257629833082_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00731198625935468044662046693815682_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00542555868158009144130993206545099_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00419942358716201159102299200753805_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,24) / &
       +0.00000000000000000000000000000000000_DP, -0.00380952380952380952050528861718703_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00398774714564188205445649515468176_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00437311444037183361110976420604857_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00503391567973129200330717480937892_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00610572223475449281371307819199501_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00785880785880785880104237861587535_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01087321087321087287325127590520424_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01656601656601656633038821553327580_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02919681944072188145566926209539815_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06723388164114199594401100057439180_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33385012919896639438377405895153061_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99952718676122931373839719526586123_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33376754957302068316238319312105887_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06706682673069228051154766490071779_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02894138787590508007929734901608754_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01621606904625772643813164108905767_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01041998936735778757967096908032545_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00729036054638195624155727614379430_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00540606008791615945396902276343098_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00418178200241845366563753216837540_DP /
  DATA cheb_product_integrals(:,25) / &
       -0.00347826086956521752027726712697131_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00355187485622268216828301135024049_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00378340487233409187434185483311921_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00420832228447845426572149207800067_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00489908573400034495076704743610208_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00599400599400599400079503453753205_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00776520776520776487283903577463207_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01079401079401079432962262671935605_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01649840674230918305398496670477471_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02913864354590389726951116244890727_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06718346253229974529563861551650916_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33380614657210400109121906098152976_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99956578376031268717838429438415915_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33373349339735897123304653177910950_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06703662597114316834545633128072950_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02891448174467042483981593647968111_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01619199513936355958043655789424520_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01039836365438506424196951627436647_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00727086195271802425421636684177429_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00538841850317260152858356292426834_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,26) / &
       +0.00000000000000000000000000000000000_DP, -0.00322061191626409016805498986002476_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00334753258291489155448750203447617_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00361861271644071252895358270507131_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00407349233874750721318136470472382_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00478736949325184613784900378163911_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00590040590040590007259169169628876_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00768600768600768632921038658878388_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01072640097030340931849590191404786_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01644023084749119886782686705828382_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02908822443706164662113877739102463_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06713947990543735200308361754650832_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33376754957302068316238319312105887_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99959983993597434359656972446828149_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33370329263780984518916739034466445_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06700971983990851310597491874432308_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02889040783777625798212085328486864_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01617036942639083624273510508828622_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01037886506072113225462860697234646_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00725322036797446632883090700261164_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00537240537240537240071258651141761_DP /
  DATA cheb_product_integrals(:,27) / &
       -0.00296296296296296281583271259307821_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00301626964295629955425948054426044_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00318274042702151220909922990642826_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00348378277070976547641345533179447_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00396177609799900840026332105026086_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00469376939965175220964566094039583_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00582120582120582152896304251044057_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00761839786230030131808366178347569_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01066822507548542686706127824436408_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01638981173864894821945448200040119_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02904424181019925679803073137463798_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06710088290635403407424774968603742_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33373349339735897123304653177910950_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99963004069552352515160009716055356_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33367638650657516219411036217934452_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06698564593301435665662069141035317_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02886878212480353464441940047890967_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01615087083272690252067071980945911_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01036122347597757432924314713318381_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00723720723720723720095993058976092_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,28) / &
       +0.00000000000000000000000000000000000_DP, -0.00275862068965517220203720327731389_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00285147748706292020887120841621254_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00304791048129056559023997152735319_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00337206652996126666349541167733150_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00386817600439891447205997820901757_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00461456932045167366601701175454764_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00575359599749843651783631770513239_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00756022196748231886664903811379190_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01061780596664317621868889318648144_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01634582911178655839634643598401453_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02900564481111593539974791156055289_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06706682673069228051154766490071779_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33370329263780984518916739034466445_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99965694682675809712435466281021945_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33365231259968103350033175047428813_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06696402022004162291057838274355163_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02884928353113960092235501520008256_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01613322924798334806473221192391065_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01034521034521034520137217072033309_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00722262811815050590619202708353441_DP /
  DATA cheb_product_integrals(:,29) / &
       -0.00255427841634738202192256295575135_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00259382853376179285664893114926599_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00271664754133197315633108104293569_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00293619424054206677732192787289023_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00327846643636117316897293783028999_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00378897592519883549475046002896761_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00454695949674428865489028694923945_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00569542010268045406640169403544860_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00750980285864006821827665305590926_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01057382333978078639558084717009478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01630723211270323699806361616992945_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02897158863545418183704782677523326_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06703662597114316834545633128072950_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33367638650657516219411036217934452_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99968102073365228132928450577310286_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33363068688670827199871382617857307_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06694452162637769265796094941833871_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02883164194639604646641650731453410_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01611721611721611893686123551105993_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01033063122615361477396600520251013_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,30) / &
       +0.00000000000000000000000000000000000_DP, -0.00238948626045400224285342183350167_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00245899858803084623778967277019092_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00260493130058347434341303738847273_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00284259414694197284911858503164694_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00319926635716109419166341965024003_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00372136610149145091730460421786120_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00448878360192630620345566327955567_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00564500099383820341802930897756596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00746582023177767839516860703952261_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01053522634069746499729802735600970_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01627317593704148343536353138460981_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02894138787590508007929734901608754_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06700971983990851310597491874432308_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33365231259968103350033175047428813_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99970264644662498731975119881099090_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33361118829304436950167200848227367_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06692688004163413473257548957917606_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02881562881562881733854553090168338_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01610263699815938504000811803962279_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01031731985658007784423251251837428_DP /
  DATA cheb_product_integrals(:,31) / &
       -0.00222469410456062289746514970545377_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00225465631472305562399416345442660_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00234728234728234742487162911572796_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00251133120698338084889056354143122_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00276339406774189387180906685159698_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00313165653345370918053669484493184_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00366319020667346846586998054817741_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00443836449308405555508327822167303_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00560101836697581359492126296117931_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00742722323269435699688578722543753_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01050117016503571143459794257069007_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01624297517749238167761305362546409_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02891448174467042483981593647968111_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06698564593301435665662069141035317_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33363068688670827199871382617857307_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99972214504028900083909547902294435_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33359354670830082545407435645756777_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06691086691086690907415146511993953_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02880104969657208344169241343024623_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01608932562858584811027462535548693_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,32) / &
       +0.00000000000000000000000000000000000_DP, -0.00208986415882967627860589132637870_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00214294007397455681107611979996364_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00225368225368225349666828627448467_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00243213112778330187158104536138126_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00269578424403450929436321104049057_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00307348063863572716278294016944983_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00361277109783121738381672649609300_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00439438186622166573197523220528637_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00556242136789249219663844314709422_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00739316705703260343418570244011789_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01047096940548660794212398883473725_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01621606904625772643813164108905767_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02889040783777625798212085328486864_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06696402022004162291057838274355163_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33361118829304436950167200848227367_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99973978662503248937554189978982322_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33357753357753355816228690855496097_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06689628779181018558563920350934495_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02878773832699854651195892074611038_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01607713916348331439909458140391507_DP /
  DATA cheb_product_integrals(:,33) / &
       -0.00195503421309872922606576395310185_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00197814791808117746568784767191573_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00204933998037446331655364595292212_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00217448217448217451935876809443471_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00236452130407591686045432055607307_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00263760834921652684292858737080678_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00302306152979347608072968611736542_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00356878847096882799438954947390812_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00435578486713834433369241239120129_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00552836519223073863393835836177459_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00736296629748350080907348669256862_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01044406327425195270264257629833082_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01619199513936355958043655789424520_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02886878212480353464441940047890967_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06694452162637769265796094941833871_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33359354670830082545407435645756777_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99975579975579975666732934769243002_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33356295445847683467377464694436640_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06688297642223664518645875887159491_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02877555186189601280077887679453852_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,34) / &
       +0.00000000000000000000000000000000000_DP, -0.00184331797235023041314772029863889_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00188454782448108375432493932777334_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00197013990117438390556325877867039_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00210687235077478994191291228332830_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00230634540925793484270056588059106_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00258718924037427576087533331872237_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00297907890293108669130250909518054_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00353019147188550659610672965982303_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00432172869147659077099232760588166_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00549816443268163600882614261422532_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00733606016624884556959207415616220_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01041998936735778757967096908032545_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01617036942639083624273510508828622_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02884928353113960092235501520008256_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06692688004163413473257548957917606_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33357753357753355816228690855496097_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99977037887485653566699284056085162_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33354964308890333590795762574998662_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06687078995713410800583176296640886_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02876436702406218182126451665681088_DP /
  DATA cheb_product_integrals(:,35) / &
       -0.00173160173160173160022967664417592_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00174971787875013691862524645159738_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00180534774528100456017498665062249_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00190253007746699932811740296756398_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00204869645595680749047828861364451_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00225592630041568376064731182850664_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00254320661351188637144815629653749_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00294048190384776529301968928109545_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00349613529622375259972577588030163_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00429152793192748814588011185833238_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00547125830144698076934473007781889_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00731198625935468044662046693815682_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01039836365438506424196951627436647_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01615087083272690252067071980945911_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02883164194639604646641650731453410_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06691086691086690907415146511993953_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33356295445847683467377464694436640_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99978369024443003443280986175523140_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33353745662380079872733062984480057_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06685960511930028049576435478229541_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,36) / &
       +0.00000000000000000000000000000000000_DP, -0.00163800163800163810570720279713441_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00167051779955005750763485927734564_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00173773792157361976588869634241519_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00184435418264901709352321379498107_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00199827734711455640842503456156010_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00221194367355329437122013480632177_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00250460961442856497316533648245240_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00290642572818601129663873550157405_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00346593453667464997461356013275235_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00426462180069283290639869932192596_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00544718439455281564637312285981352_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00729036054638195624155727614379430_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01037886506072113225462860697234646_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01613322924798334806473221192391065_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02881562881562881733854553090168338_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06689628779181018558563920350934495_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33354964308890333590795762574998662_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99979587670953251610228562640259042_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33352627178596694346168760603177361_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06684931506849314808427209300134564_DP /
  DATA cheb_product_integrals(:,37) / &
       -0.00154440154440154439434429445299202_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00155880155880155869471681562288268_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00160290797584267293018900346623923_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00167956202675563753129450716983229_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00179393507380676579462952524579578_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00195429472025216701899785753937522_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00217334667446997297293731499223668_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00247055343876681097678438270293100_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00287622496863690867152651975402478_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00343902840543999473513214759634593_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00424054789379866778342709210392059_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00542555868158009144130993206545099_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00727086195271802425421636684177429_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01036122347597757432924314713318381_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01611721611721611893686123551105993_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02880104969657208344169241343024623_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06688297642223664518645875887159491_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33353745662380079872733062984480057_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99980706154736642687907988147344440_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33351598173515983880577095987973735_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,38) / &
       +0.00000000000000000000000000000000000_DP, -0.00146520146520146520019434177584117_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00149119173509417411727095981177627_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00154473208102469069559481429365633_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00162914291791338644924125311774787_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00174995244694437640520234822361090_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00191569772116884583755547222239102_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00213929049880821897655636121271527_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00244035267921770835167216695538173_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00284931883740225343204510721761835_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00341495449854582961216054037834056_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00421892218082594357836390130955806_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00540606008791615945396902276343098_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00725322036797446632883090700261164_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01034521034521034520137217072033309_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01610263699815938504000811803962279_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02878773832699854651195892074611038_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06687078995713410800583176296640886_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33352627178596694346168760603177361_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99981735159817353153499652762548067_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33350649350649352875564090936677530_DP /
  DATA cheb_product_integrals(:,39) / &
       -0.00138600138600138600604438909869032_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00139759164149408062274848596473475_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00143301584027619188267677063919336_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00149431297218243961354156024157191_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00158516029105099705981407609556300_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00171135544786105522375996290662670_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00188164154550709162433408394576873_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00210908973925911635144414546516600_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00241344654798305311219075441897530_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00282524493050808830907349999961298_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00339332878557310540709734958397803_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00419942358716201159102299200753805_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00538841850317260152858356292426834_DP, +0.00000000000000000000000000000000000_DP, &
       -0.00723720723720723720095993058976092_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01033063122615361477396600520251013_DP, +0.00000000000000000000000000000000000_DP, &
       -0.01608932562858584811027462535548693_DP, +0.00000000000000000000000000000000000_DP, &
       -0.02877555186189601280077887679453852_DP, +0.00000000000000000000000000000000000_DP, &
       -0.06685960511930028049576435478229541_DP, +0.00000000000000000000000000000000000_DP, &
       -0.33351598173515983880577095987973735_DP, +0.00000000000000000000000000000000000_DP, &
       +0.99982683982683984158512657813844271_DP, +0.00000000000000000000000000000000000_DP /
  DATA cheb_product_integrals(:,40) / &
       +0.00000000000000000000000000000000000_DP, -0.00131839156229400121175809879048302_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00133941574667609838815429679215185_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00138259673143394080062351658710895_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00145033034532005022411438321938704_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00154656329196767566153125628147791_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00167729927219930122737900912710529_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00185144078595798899922186819821945_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00208218360802446111196273292875958_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00238937264108888842290001619517170_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00280361921753536367032944021104868_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00337383019190917341975644028195802_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00418178200241845366563753216837540_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00537240537240537240071258651141761_DP, &
       +0.00000000000000000000000000000000000_DP, -0.00722262811815050590619202708353441_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01031731985658007784423251251837428_DP, &
       +0.00000000000000000000000000000000000_DP, -0.01607713916348331439909458140391507_DP, &
       +0.00000000000000000000000000000000000_DP, -0.02876436702406218182126451665681088_DP, &
       +0.00000000000000000000000000000000000_DP, -0.06684931506849314808427209300134564_DP, &
       +0.00000000000000000000000000000000000_DP, -0.33350649350649352875564090936677530_DP, &
       +0.00000000000000000000000000000000000_DP, +0.99983560743054411545926996041089296_DP /

contains

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_piecewise_nD(coeffs1, coeffs2, &
       nodes) result(cheb_int_product)
    !==========================================================================!
    ! Calculates an integral of a product of two n-D Chebyshev polynomial      !
    ! expansions, where n > 1 (n = 2, n = 3 currently supported).              !
    !                                                                          !
    ! The integration domain is determined by the positioning of the nodes in  !
    ! the n-D domain (e.g. a sphere for n = 3, a (half-)disc for n = 2).       !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in):     Coefficients of the expansion of the first factor in !
    !                     the product.                                         !
    !   coeffs2 (in):     Coefficients of the expansion of the second factor in!
    !                     the product.                                         !
    !   nodes (in):       The nodes of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    ! Generalized by James C. Womack to support both 2-D and 3-D Chebyshev     !
    ! expansions in 2018                                                       !
    !==========================================================================!

    use utils, only: utils_abort, utils_assert

    implicit none

    ! Parameters
    integer, parameter :: allowed_n_dim(2) = [2, 3]

    ! Arguments
    type(CHEB_COEFFS), intent(in) :: coeffs1
    type(CHEB_COEFFS), intent(in) :: coeffs2
    type(CHEB_NODES), intent(in)  :: nodes

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_int_product_piecewise_nD'
    integer :: n_intervals, order ! Number of intervals and order of expansion
    integer :: n_stripes(3)       ! Number of stripes in the expansion
    integer :: yi, zi             ! Indices for Y, Z
    real(kind=DP) :: xmin, xmax ! Bounds of the interval for integration along X
    real(kind=DP) :: ymin, ymax ! Bounds of the interval for integration along Y
    real(kind=DP) :: zmin, zmax ! Bounds of the interval for integration along Z
    ! Integrals over X used to compute integral over Y
    real(kind=DP) :: integrals_x(1:nodes%ranges%n_stripes(2))
    ! Integrals over Y used to compute integral over Z
    real(kind=DP) :: integrals_y(1:nodes%ranges%n_stripes(3))
    ! Coefficients for the 1D expansions performed on the fly to compute
    ! integrals over Y and Z
    real(kind=DP) :: temp_coeffs(1:maxval(nodes%ranges%n_stripes(1:3)))

    ! ------------------------------------------------------------------------
    call utils_trace_in(myself)

    call utils_assert(coeffs1%n_intervals /= CHEB_COEFFS_ARE_INVALID, &
         myself//'Attempt to reference invalidated coefficients (1).')
    call utils_assert(coeffs2%n_intervals /= CHEB_COEFFS_ARE_INVALID, &
         myself//'Attempt to reference invalidated coefficients. (2)')

    ! JCW: Check n_dim is an allowed value
    call utils_assert(any(nodes%n_dim == allowed_n_dim(:)),&
         "Error in "//myself//": n_dim not in allowed range, [2,3].")

    ! jd: Only calculate the product if both sets of coefficients are non-null
    if ( coeffs1%n_intervals /= CHEB_COEFFS_ARE_NULL .and. &
         coeffs2%n_intervals /= CHEB_COEFFS_ARE_NULL ) then

       call utils_assert(coeffs1%n_intervals == coeffs2%n_intervals, &
            'n_intervals not compatible between sets of coefficients')
       call utils_assert(coeffs1%order == coeffs2%order, &
            'order not compatible between sets of coefficients')

       n_stripes(1:3) = nodes%ranges%n_stripes(1:3)
       n_intervals = coeffs1%n_intervals
       order = coeffs1%order
       zmin = nodes%ranges%zmin
       zmax = nodes%ranges%zmax

       if (nodes%n_dim > 2) then
          ! JCW: For n_dim = 3, n_stripes(1:3) = n_intervals * order
          call utils_assert(&
               all(n_stripes == n_intervals * order), &
               "Unexpected value of n_stripes for n_dim > 2 in "//trim(myself))

          ! JCW: Evaluate integral for functions expanded in a 3-D sphere
          do zi = 1, n_stripes(3)
             ymin = nodes%ranges%ymin(zi)
             ymax = nodes%ranges%ymax(zi)

             do yi = 1, n_stripes(2)
                xmin = nodes%ranges%xmin(yi,zi)
                xmax = nodes%ranges%xmax(yi,zi)

                ! Calculate integral over X for this Z, Y
                integrals_x(yi) = &
                    cheb_int_product_piecewise_1D( &
                    coeffs1%xcoeffs(:,yi,zi), &
                    coeffs2%xcoeffs(:,yi,zi), &
                    xmin, xmax, n_intervals, order)

             end do

             ! Generate Chebyshev expansion for integral over Y for this Z
             call cheb_expansion_piecewise_1D(temp_coeffs, integrals_x, n_intervals, &
                  order)

             ! Calculate this integral over Y for this Z
             integrals_y(zi) = &
                  cheb_int_piecewise_1D(temp_coeffs, ymin, ymax, n_intervals, order)

          end do
       else if (nodes%n_dim == 2) then
          ! JCW: For n_dim = 2, n_stripes(1)   = 1
          ! JCW:                n_stripes(2:3) = n_intervals * order
          call utils_assert(n_stripes(1) == 1.and.&
               all(n_stripes(2:3) == n_intervals * order), &
               "Unexpected value of n_stripes for n_dim == 2 in "//trim(myself))

          ! JCW: Evaluate integral for functions expanded on a 2-D disc
          do zi = 1, n_stripes(3)
             ymin = nodes%ranges%ymin(zi)
             ymax = nodes%ranges%ymax(zi)

             ! Calculate this integral over Y for this Z
             integrals_y(zi) = &
                 cheb_int_product_piecewise_1D( &
                 coeffs1%xcoeffs(1,:,zi), &
                 coeffs2%xcoeffs(1,:,zi), &
                 ymin, ymax, n_intervals, order)

          end do
       else
          ! JCW: This should never happen, as only n_dim = 2, 3 is allowed
          call utils_abort('Error in '//myself//': Unexpected value of n_dim.')
       end if

       ! JCW: The final integration over Z is the same for n_dim = 2 or 3

       ! Generate Chebyshev expansion for integral over Z
       call cheb_expansion_piecewise_1D(temp_coeffs, integrals_y, n_intervals, &
            order)

       ! The integral over Z is the final result
       cheb_int_product = &
            cheb_int_piecewise_1D(temp_coeffs, zmin, zmax, n_intervals, order)
    else
       ! jd: At least one set of coefficients is null -- return zero immediately
       cheb_int_product = 0.0_DP
    end if

    call utils_trace_out(myself)

  end function cheb_int_product_piecewise_nD
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_piecewise_1D(coeffs1, coeffs2, &
       xmin, xmax, n_intervals, order)
    !==========================================================================!
    ! Calculates an integral of a product of two piecewise, 1D Chebyshev       !
    ! polynomial expansions.                                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in):     Coefficients of the expansion of the first factor in !
    !                     the product.                                         !
    !   coeffs2 (in):     Coefficients of the expansion of the second factor in!
    !                     the product.                                         !
    !   xmin (in):        The beginning of the integration interval.           !
    !   xmax (in):        The end of the integration interval.                 !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):       The order of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_abort

    implicit none

    ! Arguments
    integer, intent(in)       :: n_intervals
    integer, intent(in)       :: order
    real(kind=DP), intent(in) :: coeffs1(:) ! 1:n_intervals*order
    real(kind=DP), intent(in) :: coeffs2(:) ! 1:n_intervals*order
    real(kind=DP), intent(in) :: xmin, xmax

    ! Local variables
    integer :: i                       ! Index
    integer :: offs                    ! Index offset for current interval
    real(kind=DP) :: delta             ! Width of an interval
    real(kind=DP) :: curxmin, curxmax  ! Bounds of the current interval
    real(kind=DP) :: accum             ! Temporary

    !------------------------------------------------------------------------

    ! If/abort used instead of assert, because this may be performance critical.
    if(n_intervals <= 0) then
       call utils_abort('n_intervals must be >0')
    end if
    if(order <= 1) then
       call utils_abort('order must be >1')
    end if

    ! Optimization: if one set of coefficients is zero, the integral is zero
    if(coeffs1(1) == CHEB_SECTION_ALL_ZERO .or. &
         coeffs2(1) == CHEB_SECTION_ALL_ZERO) then
       cheb_int_product_piecewise_1D = 0.0_DP
       return
    end if

    accum = 0.0_DP
    delta = (xmax - xmin)/real(n_intervals,kind=DP)

    if(order == 2 .and. mod(n_intervals,2) == 0) then
       ! jd: Special case, hand-optimized for order 2
       !     Implicitly uses cheb_product_integrals(1,1) = 2.0
       !                     cheb_product_integrals(2,2) = 2/3
       !     and a factor of 1/2 (half_width = 1/2 * delta)
       do i=1, 2*n_intervals, 2
          accum = accum + coeffs1(i) * coeffs2(i) + &
              0.333333333333333333333_DP * coeffs1(i+1) * coeffs2(i+1)
       end do
       cheb_int_product_piecewise_1D = accum * delta
       return
    else
       ! jd: General case
       do i=1, n_intervals
          offs = (i-1)*order
          curxmin = xmin + delta * real(i-1,kind=DP)
          curxmax = xmin + delta * real(i,kind=DP)

          accum = accum + cheb_int_product_1D(coeffs1, coeffs2, &
               curxmin, curxmax, order, offs)
       end do
    end if

    cheb_int_product_piecewise_1D = accum

  end function cheb_int_product_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_product_1D(coeffs1, coeffs2, &
       xmin, xmax, order, offs)
    !==========================================================================!
    ! Calculates an integral of a product of two single-interval, 1D Chebyshev !
    ! polynomial expansions.                                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs1 (in): Coefficients of the expansion of the first factor in the !
    !                 product. If 'offs' is ommitted, these will be indexed    !
    !                 from 1. If 'offs' is specified, the indices will be      !
    !                 shifted by 'offs'. This allows for reading data from a   !
    !                 large array easily.                                      !
    !   coeffs2 (in): As coeffs1, but for the second factor in the product.    !
    !   xmin (in):   The beginning of the integration interval.                !
    !   xmax (in):   The end of the integration interval.                      !
    !   order (in):  The order of the expansion.                               !
    !   offs (in):   OPTIONAL offset in the coeffs1 and coeffs2 arrays.        !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012.                                 !
    ! Manually unrolled by Jacek Dziedzic, February 2014.                      !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in)     :: coeffs1(:)
    real(kind=DP), intent(in)     :: coeffs2(:)
    real(kind=DP), intent(in)     :: xmin, xmax
    integer, intent(in)           :: order
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: n, m               ! Indices
    real(kind=DP) :: half_width   ! Half of the interval width
    real(kind=DP) :: accum        ! Temporary
    integer :: local_offs         ! Copy of optional argument, or default value

    !------------------------------------------------------------------------

    half_width = 0.5_DP * (xmax-xmin)

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    ! jd: Manually-unrolled versions are provided for order 8, 10, 12, 14, as
    !     those would be most often used in practice. The default branch
    !     calculates the result as a double loop. The manually-unrolled version
    !     was 25% faster on my testcase on my system. An attempt to change
    !     the inner loop into a sum() intrinsic degraded performance, probably
    !     because an intermediate array was stored.
    select case(order)
    case(8)
       accum = &
            coeffs1(local_offs+1) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,1) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,1) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,1) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,1) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,1) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,1) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,1) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,1)) + &
            coeffs1(local_offs+2) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,2) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,2) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,2) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,2) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,2) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,2) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,2) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,2)) + &
            coeffs1(local_offs+3) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,3) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,3) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,3) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,3) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,3) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,3) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,3) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,3)) + &
            coeffs1(local_offs+4) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,4) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,4) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,4) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,4) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,4) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,4) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,4) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,4)) + &
            coeffs1(local_offs+5) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,5) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,5) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,5) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,5) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,5) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,5) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,5) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,5)) + &
            coeffs1(local_offs+6) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,6) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,6) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,6) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,6) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,6) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,6) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,6) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,6)) + &
            coeffs1(local_offs+7) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,7) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,7) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,7) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,7) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,7) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,7) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,7) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,7)) + &
            coeffs1(local_offs+8) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,8) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,8) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,8) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,8) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,8) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,8) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,8) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,8))
    case(10)
       accum = &
            coeffs1(local_offs+1) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,1) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,1) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,1) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,1) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,1) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,1) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,1) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,1) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,1) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,1)) + &
            coeffs1(local_offs+2) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,2) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,2) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,2) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,2) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,2) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,2) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,2) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,2) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,2) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,2)) + &
            coeffs1(local_offs+3) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,3) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,3) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,3) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,3) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,3) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,3) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,3) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,3) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,3) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,3)) + &
            coeffs1(local_offs+4) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,4) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,4) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,4) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,4) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,4) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,4) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,4) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,4) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,4) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,4)) + &
            coeffs1(local_offs+5) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,5) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,5) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,5) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,5) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,5) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,5) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,5) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,5) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,5) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,5)) + &
            coeffs1(local_offs+6) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,6) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,6) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,6) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,6) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,6) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,6) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,6) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,6) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,6) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,6)) + &
            coeffs1(local_offs+7) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,7) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,7) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,7) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,7) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,7) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,7) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,7) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,7) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,7) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,7)) + &
            coeffs1(local_offs+8) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,8) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,8) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,8) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,8) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,8) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,8) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,8) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,8) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,8) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,8)) + &
            coeffs1(local_offs+9) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,9) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,9) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,9) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,9) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,9) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,9) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,9) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,9) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,9) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,9)) + &
            coeffs1(local_offs+10) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,10) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,10) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,10) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,10) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,10) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,10) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,10) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,10) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,10) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,10))
    case(12)
       accum = &
            coeffs1(local_offs+1) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,1) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,1) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,1) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,1) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,1) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,1) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,1) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,1) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,1) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,1) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,1) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,1)) + &
            coeffs1(local_offs+2) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,2) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,2) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,2) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,2) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,2) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,2) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,2) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,2) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,2) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,2) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,2) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,2)) + &
            coeffs1(local_offs+3) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,3) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,3) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,3) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,3) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,3) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,3) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,3) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,3) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,3) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,3) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,3) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,3)) + &
            coeffs1(local_offs+4) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,4) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,4) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,4) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,4) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,4) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,4) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,4) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,4) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,4) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,4) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,4) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,4)) + &
            coeffs1(local_offs+5) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,5) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,5) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,5) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,5) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,5) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,5) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,5) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,5) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,5) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,5) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,5) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,5)) + &
            coeffs1(local_offs+6) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,6) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,6) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,6) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,6) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,6) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,6) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,6) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,6) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,6) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,6) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,6) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,6)) + &
            coeffs1(local_offs+7) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,7) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,7) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,7) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,7) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,7) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,7) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,7) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,7) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,7) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,7) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,7) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,7)) + &
            coeffs1(local_offs+8) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,8) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,8) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,8) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,8) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,8) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,8) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,8) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,8) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,8) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,8) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,8) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,8)) + &
            coeffs1(local_offs+9) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,9) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,9) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,9) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,9) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,9) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,9) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,9) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,9) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,9) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,9) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,9) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,9)) + &
            coeffs1(local_offs+10) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,10) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,10) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,10) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,10) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,10) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,10) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,10) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,10) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,10) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,10) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,10) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,10)) + &
            coeffs1(local_offs+11) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,11) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,11) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,11) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,11) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,11) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,11) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,11) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,11) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,11) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,11) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,11) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,11)) + &
            coeffs1(local_offs+12) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,12) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,12) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,12) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,12) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,12) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,12) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,12) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,12) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,12) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,12) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,12) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,12))
    case(14)
       accum = &
            coeffs1(local_offs+1) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,1) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,1) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,1) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,1) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,1) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,1) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,1) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,1) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,1) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,1) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,1) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,1) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,1) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,1)) + &
            coeffs1(local_offs+2) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,2) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,2) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,2) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,2) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,2) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,2) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,2) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,2) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,2) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,2) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,2) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,2) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,2) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,2)) + &
            coeffs1(local_offs+3) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,3) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,3) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,3) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,3) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,3) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,3) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,3) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,3) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,3) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,3) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,3) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,3) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,3) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,3)) + &
            coeffs1(local_offs+4) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,4) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,4) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,4) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,4) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,4) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,4) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,4) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,4) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,4) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,4) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,4) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,4) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,4) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,4)) + &
            coeffs1(local_offs+5) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,5) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,5) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,5) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,5) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,5) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,5) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,5) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,5) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,5) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,5) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,5) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,5) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,5) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,5)) + &
            coeffs1(local_offs+6) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,6) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,6) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,6) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,6) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,6) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,6) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,6) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,6) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,6) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,6) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,6) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,6) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,6) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,6)) + &
            coeffs1(local_offs+7) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,7) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,7) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,7) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,7) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,7) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,7) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,7) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,7) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,7) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,7) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,7) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,7) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,7) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,7)) + &
            coeffs1(local_offs+8) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,8) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,8) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,8) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,8) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,8) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,8) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,8) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,8) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,8) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,8) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,8) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,8) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,8) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,8)) + &
            coeffs1(local_offs+9) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,9) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,9) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,9) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,9) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,9) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,9) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,9) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,9) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,9) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,9) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,9) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,9) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,9) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,9)) + &
            coeffs1(local_offs+10) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,10) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,10) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,10) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,10) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,10) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,10) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,10) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,10) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,10) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,10) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,10) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,10) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,10) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,10)) + &
            coeffs1(local_offs+11) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,11) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,11) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,11) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,11) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,11) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,11) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,11) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,11) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,11) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,11) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,11) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,11) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,11) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,11)) + &
            coeffs1(local_offs+12) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,12) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,12) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,12) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,12) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,12) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,12) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,12) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,12) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,12) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,12) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,12) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,12) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,12) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,12)) + &
            coeffs1(local_offs+13) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,13) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,13) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,13) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,13) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,13) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,13) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,13) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,13) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,13) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,13) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,13) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,13) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,13) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,13)) + &
            coeffs1(local_offs+14) * (&
            coeffs2(local_offs+1) * cheb_product_integrals(1,14) + &
            coeffs2(local_offs+2) * cheb_product_integrals(2,14) + &
            coeffs2(local_offs+3) * cheb_product_integrals(3,14) + &
            coeffs2(local_offs+4) * cheb_product_integrals(4,14) + &
            coeffs2(local_offs+5) * cheb_product_integrals(5,14) + &
            coeffs2(local_offs+6) * cheb_product_integrals(6,14) + &
            coeffs2(local_offs+7) * cheb_product_integrals(7,14) + &
            coeffs2(local_offs+8) * cheb_product_integrals(8,14) + &
            coeffs2(local_offs+9) * cheb_product_integrals(9,14) + &
            coeffs2(local_offs+10) * cheb_product_integrals(10,14) + &
            coeffs2(local_offs+11) * cheb_product_integrals(11,14) + &
            coeffs2(local_offs+12) * cheb_product_integrals(12,14) + &
            coeffs2(local_offs+13) * cheb_product_integrals(13,14) + &
            coeffs2(local_offs+14) * cheb_product_integrals(14,14))
    case default
       accum = 0D0
       do n = 1, order
          do m = 1, order
             accum = accum + coeffs1(local_offs+n) * coeffs2(local_offs+m) * &
                  cheb_product_integrals(m,n)
          end do
       end do
    end select

    cheb_int_product_1D = half_width * accum

  end function cheb_int_product_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_sphere(coeffs, nodes)
    !==========================================================================!
    ! Calculates an integral of a 3D Chebyshev expansion over a sphere.        !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (in): The coefficients of the expansion.                        !
    !   nodes (in):  The nodes of the expansion.                               !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use utils, only: utils_assert

    implicit none

    ! Arguments
    type(CHEB_COEFFS), intent(in) :: coeffs
    type(CHEB_NODES), intent(in)  :: nodes

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_int'
    integer :: n_intervals, order ! Number of intervals and order of expansion
    integer :: n_stripes(3)       ! Number of stripes along any direction
    integer :: yi, zi             ! Indices for Y, Z
    real(kind=DP) :: xmin, xmax ! Bounds of the interval for integration along X
    real(kind=DP) :: ymin, ymax ! Bounds of the interval for integration along Y
    real(kind=DP) :: zmin, zmax ! Bounds of the interval for integration along Z
    ! Integrals over X used to compute integral over Y
    real(kind=DP) :: integrals_x(1:nodes%ranges%n_stripes(2))
    ! Integrals over Y used to compute integral over Z
    real(kind=DP) :: integrals_y(1:nodes%ranges%n_stripes(3))
    ! Coefficients for the 1D expansions performed on the fly to compute
    ! integrals over Y and Z
    real(kind=DP) :: temp_coeffs(1:maxval(nodes%ranges%n_stripes(1:3)))

    ! ------------------------------------------------------------------------
    call utils_trace_in(myself)

    n_intervals = coeffs%n_intervals

    call utils_assert(n_intervals /= CHEB_COEFFS_ARE_INVALID, &
         myself//'Attempt to reference invalidated coefficients.')

    ! JCW: Check that Chebyshev expansion is 3-D
    call utils_assert(coeffs%n_dim == 3, "Error in "//myself//": &
         &Only 3-D Chebyshev expansions are supported by this routine.")

    ! jd: Only calculate the integral if the set of coefficients is non-null
    if (n_intervals /= CHEB_COEFFS_ARE_NULL) then

       n_stripes(1:3) = nodes%ranges%n_stripes(1:3)
       order = coeffs%order
       zmin = nodes%ranges%zmin
       zmax = nodes%ranges%zmax

       do zi = 1, n_stripes(3)
          ymin = nodes%ranges%ymin(zi)
          ymax = nodes%ranges%ymax(zi)

          do yi = 1, n_stripes(2)
             xmin = nodes%ranges%xmin(yi,zi)
             xmax = nodes%ranges%xmax(yi,zi)

             ! Calculate integral over X for this Z, Y
             integrals_x(yi) = &
                  cheb_int_piecewise_1D( &
                  coeffs%xcoeffs(:,yi,zi), &
                  xmin, xmax, n_intervals, order)

          end do

          ! Generate Chebyshev expansion for integral over Y for this Z
          call cheb_expansion_piecewise_1D(temp_coeffs, integrals_x, &
               n_intervals, order)

          ! Calculate this integral over Y for this Z
          integrals_y(zi) = &
               cheb_int_piecewise_1D(temp_coeffs, ymin, ymax, n_intervals, order)

       end do

       ! Generate Chebyshev expansion for integral over Z
       call cheb_expansion_piecewise_1D(temp_coeffs, integrals_y, n_intervals, &
            order)

       ! The integral over Z is the final result
       cheb_int_sphere = &
            cheb_int_piecewise_1D(temp_coeffs, zmin, zmax, n_intervals, order)
    else
       ! jd: The set of coefficients is null -- return zero immediately
       cheb_int_sphere = 0.0_DP
    end if

    call utils_trace_out(myself)

  end function cheb_int_sphere
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_piecewise_1D(coeffs, xmin, xmax, &
       n_intervals, order)
    !==========================================================================!
    ! Calculates an integral of a piecewise, 1D Chebyshev expansion.           !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (in):      Coefficients of the expansion.                       !
    !   xmin (in):        The beginning of the integration interval.           !
    !   xmax (in):        The end of the integration interval.                 !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):       The order of the expansion.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use rundat, only: pub_debug
    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)       :: n_intervals
    integer, intent(in)       :: order
    real(kind=DP), intent(in) :: coeffs(1:n_intervals*order)
    real(kind=DP), intent(in) :: xmin, xmax

    ! Local variables
    integer :: i                      ! index
    integer :: offs                   ! index offset for current interval
    real(kind=DP) :: delta            ! width of an interval
    real(kind=DP) :: curxmin, curxmax ! bounds of the current interval
    real(kind=DP) :: accum            ! temporary

    !------------------------------------------------------------------------

    if(pub_debug) then
       call utils_assert(n_intervals > 0,'n_intervals must be >0')
       call utils_assert(order > 1,'order must be >1')
    end if

    ! Optimization: if the set of coefficients is zero, the integral is zero
    if(coeffs(1) == CHEB_SECTION_ALL_ZERO) then
       cheb_int_piecewise_1D = 0.0_DP
       return
    end if

    delta = (xmax - xmin)/real(n_intervals,kind=DP)
    accum = 0.0_DP
    do i=1, n_intervals
       offs = (i-1)*order
       curxmin = xmin + delta * real(i-1,kind=DP)
       curxmax = xmin + delta * real(i,kind=DP)

       accum = accum + cheb_int_1D(coeffs, curxmin, curxmax, order, offs)
    end do

    cheb_int_piecewise_1D = accum

  end function cheb_int_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_int_1D(coeffs, xmin, xmax, order, offs)
    !==========================================================================!
    ! Calculates an integral of a single-interval, 1D Chebyshev expansion.     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (in): Coefficients of the expansion. If 'offs' is ommitted,     !
    !                these will be indexed from 1. If 'offs' is specified,     !
    !                the indices will be shifted by 'offs'. This allows for    !
    !                reading data from a large array easily.                   !
    !   xmin (in):   The beginning of the integration interval.                !
    !   xmax (in):   The end of the integration interval.                      !
    !   order (in):  The order of the expansion.                               !
    !   offs (in):   OPTIONAL offset in the coeffs array.                      !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in)     :: coeffs(:)
    real(kind=DP), intent(in)     :: xmin, xmax
    integer, intent(in)           :: order
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: i                  ! index
    real(kind=DP) :: half_width   ! half the width of the interval
    real(kind=DP) :: accum        ! temporary
    integer :: local_offs         ! local copy of 'offs', or default if omitted

    !------------------------------------------------------------------------

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    half_width = 0.5_DP * (xmax-xmin)

    ! Only every 2nd integral is nonzero, the remaining integrands are odd
    accum = 0.0_DP
    do i = 1, order, 2
       accum = accum + &
            coeffs(local_offs+i) * cheb_integrals(i)
    end do

    cheb_int_1D = half_width * accum

  end function cheb_int_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_piecewise_nD(coeffs, nodes, values)
    !==========================================================================!
    ! Generates a piecewise Chebyshev polynomial expansion for a function      !
    ! over an n-D domain, where n > 1 (n = 2, n = 3 currently supported)       !
    !                                                                          !
    ! For a 1D domain, use cheb_expansion_piecewise_1D.                        !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (inout): The calculated coefficients will be returned here.     !
    !                   This argument must be first allocated by passing it    !
    !                   to cheb_alloc_coeffs, that's why it is (inout).        !
    !   nodes (in):     The Chebyshev nodes for the domain, obtained from      !
    !                   cheb_gen_nodes_piecewise_nD.                           !
    !   values (in):    The values at the Chebyshev nodes.                     !
    !--------------------------------------------------------------------------!
    ! Written by James C. Womack, June 2018, largely derived from the sphere-  !
    ! specific form cheb_expansion_for_sphere, by Jacek Dziedzic, January 2012 !
    !==========================================================================!

    use utils, only: utils_abort, utils_assert

    implicit none

    ! Parameters
    character(len=*), parameter :: myself = 'cheb_expansion_piecewise_nD'
    integer, parameter :: allowed_n_dim(2) = [2, 3]

    ! Arguments
    type(CHEB_COEFFS), intent(inout) :: coeffs
    type(CHEB_NODES), intent(in)     :: nodes
    real(kind=DP), intent(in)        :: values(:)

    ! Local variables
    integer :: yi, zi            ! Indices for Y, Z
    integer :: n_stripes(3)      ! Number of stripes along each direction
    integer :: base              ! Offset into sph_values

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    call utils_assert(coeffs%n_intervals /= 0 .and. coeffs%order /= 0, &
         "Allocate coeffs with cheb_alloc_coeffs before calling " &
         //trim(myself))

    ! JCW: Check n_dim is an allowed value
    call utils_assert(any(nodes%n_dim == allowed_n_dim(:)),&
         "Error in "//myself//": n_dim not in allowed range, [2,3].")

    ! JCW: Set n_stripes based on values previously determined in
    ! JCW: cheb_gen_nodes_piecewise_nD (based on n_dim).
    n_stripes(1:3) = nodes%ranges%n_stripes(1:3)

    if (nodes%n_dim > 2) then
       ! JCW: For n_dim = 3, n_stripes(1:3) = n_intervals * order
       call utils_assert(all(n_stripes == coeffs%n_intervals * coeffs%order), &
            "Unexpected value of n_stripes for n_dim > 2 in "//trim(myself))

       ! JCW: Compute Chebyshev coefficients for 1-D slices along x-direction
       ! JCW: for each y,z node in a 3-D sphere ( coeffs%xcoeffs has allocated
       ! JCW: dimensions (n_stripes(1),n_stripes(2),n_stripes(3)) )
       do zi = 1, n_stripes(3)
          do yi = 1, n_stripes(2)

             base = 1 + (yi-1) * n_stripes(1) + (zi-1) * n_stripes(1)*n_stripes(2)

             call cheb_expansion_piecewise_1D( &
                  coeffs%xcoeffs(:,yi,zi), &
                  values, coeffs%n_intervals, coeffs%order, base)

          end do
       end do

    else if (nodes%n_dim == 2) then
       ! JCW: For n_dim = 2, n_stripes(1)   = 1
       ! JCW:                n_stripes(2:3) = n_intervals * order
       call utils_assert(n_stripes(1) == 1.and.&
            all(n_stripes(2:3) == coeffs%n_intervals * coeffs%order), &
            "Unexpected value of n_stripes for n_dim == 2 in "//trim(myself))

       ! JCW: Compute Chebyshev coefficients for 1-D slices along y-direction
       ! JCW: for each z node in a 2-D disc ( coeffs%xcoeffs has allocated
       ! JCW: dimensions (1,n_stripes(2),n_stripes(3)) )
       do zi = 1, n_stripes(3)

          base = 1 + (zi-1) * n_stripes(2)

          call cheb_expansion_piecewise_1D( &
               coeffs%xcoeffs(1,:,zi), &
               values, coeffs%n_intervals, coeffs%order, base)

       end do
    else
       ! JCW: This should never happen, as only n_dim = 2, 3 is allowed
       call utils_abort('Error in '//myself//': Unexpected value of n_dim.')
    end if

    call utils_trace_out(myself)

  end subroutine cheb_expansion_piecewise_nD
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_piecewise_1D(coeffs, values, n_intervals, order, &
       base)
    !==========================================================================!
    ! Generates a piecewise, 1D Chebyshev polynomial expansion for a list of   !
    ! function values computed at a set of Chebyshev nodes.                    !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (out):  Here the calculated coefficients are returned.          !
    !                  The coefficients are stored as a 1D array with coeffs   !
    !                  for the first interval first, then coeffs for the second!
    !                  interval, etc. The array is always indexed from 1.      !
    !   values (in):   Values of the function to be expanded, computed at      !
    !                  Chebyshev nodes for subsequent intervals. The indices   !
    !                  are offset by 'base' (if specified), which allows the   !
    !                  values to be read from a longer array without the need  !
    !                  to create extra temporaries.                            !
    !   n_intervals (in): The number of intervals for the expansion.           !
    !   order (in):    Order of the Chebyshev expansion.                       !
    !   base (in):     OPTIONAL offset of data in 'values'. Omit if not needed.!
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use rundat, only: pub_debug
    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)           :: n_intervals, order
    real(kind=DP), intent(out)    :: coeffs(1:n_intervals*order)
    real(kind=DP), intent(in)     :: values(:)
    integer, intent(in), optional :: base

    ! Local variables
    integer :: i                       ! Number of current interval
    integer :: offs                    ! Offset to current interval
    integer :: local_base              ! Local copy of 'base', default if absent

    !------------------------------------------------------------------------

    if(pub_debug) call utils_assert(n_intervals > 0,'n_intervals must be > 0')

    if(present(base)) then
       local_base = base
    else
       local_base = 1
    end if

    do i=1, n_intervals
       offs = (i-1)*order
       call cheb_expansion_1D(coeffs, values, order, local_base, offs)
    end do

    ! If the expansion is all zeroes, take note
    if(maxval(coeffs(:)) == 0.0_DP) then
       if(minval(coeffs(:)) == 0.0_DP) then
          coeffs(1) = CHEB_SECTION_ALL_ZERO
       end if
    end if

  end subroutine cheb_expansion_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_expansion_1D(coeffs, values, order, base, offs)
    !==========================================================================!
    ! Generates a single-interval, 1D Chebyshev polynomial expansion for a     !
    ! list of function values computed at Chebyshev nodes.                     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (out):  Here the calculated coefficients are returned.          !
    !                  If 'offs' is omitted, they are written starting from an !
    !                  index of 1. If 'offs' is present, it is used to offset  !
    !                  the indices. This is useful when writing to a longer    !
    !                  array (e.g. with piecewise expansion).                  !
    !   values (in):   Values of the function to be expanded, computed at      !
    !                  Chebyshev nodes. This too is offset by 'offs', if this  !
    !                  is specified. This is useful when reading values from a !
    !                  longer array (e.g. wioth piecewise expansion).          !
    !                  The indices in values are also offset by 'base', if this!
    !                  is specified. This is useful when reading values from a !
    !                  longer array (e.g. a set of piecewise expansions).      !
    !   order (in):    Order of the Chebyshev expansion.                       !
    !   base (in):     OPTIONAL offset of data in 'values'. Omit if not needed.!
    !   offs (in):     OPTIONAL offset of data in 'values' and 'coeffs'.       !
    !                  Omit if not needed.                                     !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI, DP, SQRT_TWO

    implicit none

    ! Arguments
    integer, intent(in)           :: order
    real(kind=DP), intent(out)    :: coeffs(:)
    real(kind=DP), intent(in)     :: values(:)
    integer, intent(in), optional :: base
    integer, intent(in), optional :: offs

    ! Local variables
    integer :: i, k           ! indices
    integer :: local_base     ! } local copies of optional parameters,
    integer :: local_offs     ! } or default values if absent
    real(kind=DP) :: delta    ! KroneckerDelta_{i,0}
    real(kind=DP) :: ord      ! order as a real
    real(kind=DP) :: factor   ! temporary
    real(kind=DP) :: accum    ! temporary
    real(kind=DP) :: v0, v1   ! temporary

    !------------------------------------------------------------------------

    if(present(base)) then
       local_base = base
    else
       local_base = 1
    end if

    if(present(offs)) then
       local_offs = offs
    else
       local_offs = 0
    end if

    ! Hand-optimized version for order == 2
    if(order == 2) then
       v0 = 0.5_DP * values(local_base + local_offs)
       v1 = 0.5_DP * values(local_base + local_offs + 1)
       coeffs(local_offs+1) = v0+v1
       coeffs(local_offs+2) = SQRT_TWO * (v0-v1)
       return
    else
       v0=0 ! jme: this prevents
       v1=0 ! 'unused variables' warnings
    end if

    ord = real(order,kind=DP)
    delta = 1.0_DP ! KroneckerDelta_{i,0}
    do i = 0, order-1
       factor = (2.0_DP - delta)/ord
       accum = 0.0_DP
       do k = 0, order-1
          accum = accum + &
               cos(i*PI*(k+0.5_DP)/ord) * values(local_base + local_offs + k)
       end do
       coeffs(local_offs + i+1) = factor * accum

       delta = 0.0_DP
    end do

  end subroutine cheb_expansion_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_piecewise_nD(nodes, n_dim, rad, n_intervals, order,&
       half_domain)
    !==========================================================================!
    ! Generates Chebyshev nodes for piecewise integration over an n-D domain,  !
    ! where n > 1 (n = 2, n = 3 currently supported)                           !
    !                                                                          !
    ! For a 1D domain, use cheb_gen_nodes_piecewise_1D.                        !
    !                                                                          !
    ! The integration domain is centred about the origin, i.e.                 !
    ! * Disc is centred on (0,0)                                               !
    ! * Sphere is centred on (0,0,0)                                           !
    !                                                                          !
    ! The integration domains are                                              !
    ! * half_domain == .false. (the default)                                   !
    !   - Disc,   ( [-ry,+ry], [-rz,+rz] )                                     !
    !   - Sphere, ( [-rx,+rx], [-ry,+ry], [-rz,+rz] )                          !
    ! * half_domain == .true., the integration domains are                     !
    !   - Disc,   ( [ 0 ,+ry], [-rz,+rz] )                                     !
    !   - Sphere, ( [-rx,+rx], [ 0 ,+ry], [-rz,+rz] )                          !
    ! with                                                                     !
    !  rz = rad                                                                !
    !  ry = sqrt(rad^2 - z^2)                                                  !
    !  rx = sqrt(rad^2 - z^2 - y^2)                                            !
    ! and where y and z are coordinates in the integration domain.             !
    !                                                                          !
    ! In other words:                                                          !
    ! * Along the z-direction, there are n_stripes = n_intervals * order nodes !
    !   which subdivide the region [-rz,+rz].                                  !
    ! * For each z-node there are n_stripes nodes along the y-direction,       !
    !   subdividing the region [-ry,+ry].                                      !
    ! * For each yz-node (in a 3-D sphere) there are n_stripes nodes along the !
    !   x-direction, subdividing the region [-rx,+rx].                         !
    !                                                                          !
    ! Setting half_domain == .true. with n_dim == 2 positions nodes at         !
    ! Cartesian coordinates in an integration domain which is equivalent to    !
    ! integration over r in [0,rad], theta in [0,pi] in polar coordinates.     !
    !                                                                          !
    ! Note that if half_domain == .true., then the same number of nodes are    !
    ! used in an integration domain which is half the size of the full sphere  !
    ! or disc domain, so the sampling of the functions will be more dense.     !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   nodes (out)      : A CHEB_NODES variable holding the generated nodes.  !
    !   n_dim (in)       : Dimensions of the integration domain (2, 3)         !
    !   rad (in)         : The radius of the disc, or sphere.                  !
    !   n_intervals (in) : Number of intervals along each Cartesian direction. !
    !   order (in)       : The order of Chebyshev expansion to use.            !
    !   half_domain (in) : Optional, if true then only place nodes in half of  !
    !                      the domain (default false).                         !
    !--------------------------------------------------------------------------!
    ! Written by James C. Womack, June 2018, largely derived from the sphere-  !
    ! specific form cheb_gen_nodes_for_sphere, by Jacek Dziedzic, January 2012 !
    !==========================================================================!

    use utils, only: utils_alloc_check, utils_assert

    implicit none

    ! Parameters
    integer, parameter :: allowed_n_dim(2) = [2, 3]

    ! Arguments
    type(CHEB_NODES), intent(out) :: nodes
    integer, intent(in) :: n_dim
    real(kind=DP), intent(in) :: rad
    integer, intent(in) :: n_intervals
    integer, intent(in) :: order
    logical, intent(in), optional :: half_domain

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_gen_nodes_piecewise_nD'

    integer :: n_stripes(3)      ! Number of nodes (intervals * order along
                                 ! each direction)
    integer :: yi, zi            ! Indices for stripes in y, z
    real(kind=DP) :: xmin, xmax  ! Integration interval over X for current Y, Z
    real(kind=DP) :: ymin, ymax  ! Integration interval over Y for current Z
    real(kind=DP) :: zmin, zmax  ! Integration interval over Z (== [-rad,rad])
    real(kind=DP) :: rx, ry      ! Half the interval over X, Y, respectively
    real(kind=DP) :: y, z        ! Current Y, Z corresponding to yi, zi
    logical :: half_domain_loc
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    ! JCW: Check n_dim is an allowed value
    call utils_assert(any(n_dim == allowed_n_dim(:)),&
         "Error in "//myself//": n_dim not in allowed range, [2,3].")

    ! JCW: Set number of dimensions
    nodes%n_dim = n_dim

    ! JCW: Check optional arguments and set values of local versions
    if (present(half_domain)) then
       half_domain_loc = half_domain
    else
       half_domain_loc = .false.
    end if

    ! JCW: Initialize n_stripes along all directions to one.
    ! JCW: We can then calculate number of points as product(n_stripes(1:3))
    ! JCW: regardless of the number of dimensions we are actually generating
    ! JCW: nodes for.
    n_stripes(1:3) = 1

    ! JCW: n_dim always > 1, so stripes along z (3) and y (2) always non-zero
    n_stripes(2:3) = n_intervals * order

    ! JCW: n_dim always > 1, so need to allocate znodes and ynodes
    allocate(nodes%znodes(n_stripes(3)),stat=ierr)
    call utils_alloc_check(myself,'nodes%znodes',ierr)
    allocate(nodes%ynodes(n_stripes(2),n_stripes(3)),stat=ierr)
    call utils_alloc_check(myself,'nodes%ynodes',ierr)
    allocate(nodes%ranges%ymin(n_stripes(3)),stat=ierr)
    call utils_alloc_check(myself,'nodes%ranges%ymin',ierr)
    allocate(nodes%ranges%ymax(n_stripes(3)),stat=ierr)
    call utils_alloc_check(myself,'nodes%ranges%ymax',ierr)

    if (n_dim > 2) then
       ! JCW: Set n_stripes along x (1) for n_dim > 2
       n_stripes(1) = n_intervals * order
       ! JCW: Allocate xnodes for n_dim > 2
       allocate(nodes%xnodes(n_stripes(1),n_stripes(2),n_stripes(3)),stat=ierr)
       call utils_alloc_check(myself,'nodes%xnodes',ierr)
       allocate(nodes%ranges%xmin(n_stripes(2),n_stripes(3)),stat=ierr)
       call utils_alloc_check(myself,'nodes%ranges%xmin',ierr)
       allocate(nodes%ranges%xmax(n_stripes(2),n_stripes(3)),stat=ierr)
       call utils_alloc_check(myself,'nodes%ranges%xmax',ierr)
    end if

    zmin = -rad
    zmax = +rad

    nodes%ranges%n_stripes = n_stripes
    nodes%ranges%zmin = zmin
    nodes%ranges%zmax = zmax

    ! Generate Chebyshev nodes for distribution along Z
    call cheb_gen_nodes_piecewise_1D(nodes%znodes, zmin, zmax, &
         n_intervals, order)

    do zi = 1, n_stripes(3)
       z = nodes%znodes(zi)

       ! Determine range in which Y changes for this Z
       ry = rad*rad - z*z
       if(ry < 0.0_DP) then
          ry = 0.0_DP ! handle rounding errors
       else
          ry = sqrt(ry)
       end if

       ! JCW: If half_domain is true, then only position nodes from 0 to ry
       ! JCW: rather than -ry to ry, yielding a half-disc (n_dim == 2) or
       ! JCW: hemisphere (n_dim == 3) integration domain.
       if (half_domain_loc) then
          ymin = 0.0_DP
       else
          ymin = -ry
       end if
       ymax = +ry

       nodes%ranges%ymin(zi) = ymin
       nodes%ranges%ymax(zi) = ymax

       ! Generate Chebyshev nodes for distribution along Y for this Z
       call cheb_gen_nodes_piecewise_1D(nodes%ynodes(:,zi), ymin, ymax, &
            n_intervals, order)

       ! JCW: Don't evaluate x-nodes if n_dim not > 2
       if (.not.n_dim > 2) cycle
       do yi = 1, n_stripes(2)
          y = nodes%ynodes(yi,zi)

          ! Determine range in which X changes for this Z, Y
          rx = rad*rad - z*z - y*y
          if(rx < 0.0_DP) then
             rx = 0.0_DP ! handle rounding errors
          else
             rx = sqrt(rx)
          end if
          xmin = -rx
          xmax = +rx

          nodes%ranges%xmin(yi,zi) = xmin
          nodes%ranges%xmax(yi,zi) = xmax

          ! Generate Chebyshev nodes for distribution along X for this Z, Y
          call cheb_gen_nodes_piecewise_1D(nodes%xnodes(:,yi,zi), &
               xmin, xmax, n_intervals, order)

       end do ! over Y
    end do ! over Z

    nodes%n_points_total = product(n_stripes(1:3))

    call utils_trace_out(myself)

  end subroutine cheb_gen_nodes_piecewise_nD
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_piecewise_1D(nodes, xmin, xmax, n_intervals, &
       order)
    !==========================================================================!
    ! Calculalates the location of Chebyshev nodes of a given order, for       !
    ! a Chebyshev expansion in [xmin, xmax] on n_intervals intervals.          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   nodes (out):      An array (order * n_intervals elements long) where   !
    !                     the nodes for every interval will be returned.       !
    !   xmin, xmax (in):  Define the range on which the interpolation will be  !
    !                     performed.                                           !
    !   n_intervals (in): The number of intervals.                             !
    !   order (in):       The order of Chebyshev interpolation.                !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    integer, intent(in)        :: order
    integer, intent(in)        :: n_intervals
    real(kind=DP), intent(out) :: nodes(1:n_intervals*order)
    real(kind=DP), intent(in)  :: xmin, xmax

    ! Local variables
    integer :: i
    integer :: base           ! Shift inside nodes(:) for current interval
    real(kind=DP) :: delta    ! Width of one interval
    real(kind=DP) :: curxmin, curxmax ! xmin, xmax for current interval

    !------------------------------------------------------------------------
    delta = (xmax - xmin)/real(n_intervals,kind=DP)
    do i=1, n_intervals
       base = (i-1)*order
       curxmin = xmin + delta * real(i-1,kind=DP)
       curxmax = xmin + delta * real(i,kind=DP)

       call cheb_gen_nodes_1D(nodes(base+1:base+order), &
            curxmin,curxmax,order)
    end do

  end subroutine cheb_gen_nodes_piecewise_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_gen_nodes_1D(nodes, xmin, xmax, order)
    !==========================================================================!
    ! Calculalates the location of Chebyshev nodes of a given order, for       !
    ! a Chebyshev expansion in [xmin, xmax].                                   !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   nodes (out):     An array ('order' elements long) where the nodes will !
    !                    be returned.                                          !
    !   xmin, xmax (in): Define the range on which the interpolation will be   !
    !                    performed.                                            !
    !   order (in)     : The order of Chebyshev interpolation.                 !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use constants, only: PI
    use utils, only: utils_assert

    implicit none

    ! Arguments
    integer, intent(in)        :: order
    real(kind=DP), intent(out) :: nodes(1:order)
    real(kind=DP), intent(in)  :: xmin, xmax

    ! Local variables
    integer :: i

    !------------------------------------------------------------------------
    call utils_assert(order > 0 .and. order <= max_cheb_order, &
         'Invalid Chebyshev expansion order.', order)

    do i=0, order-1
       nodes(i+1) = cheb_unscale_x(cos(PI*((order-1)-i+0.5_DP)/order),xmin,xmax)
    end do

  end subroutine cheb_gen_nodes_1D
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_scale_x(x, xmin, xmax)
    !==========================================================================!
    ! Linear transformation of x in [xmin,xmax] to x' in [-1,1].               !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   x, xmin, xmax (in)                                                     !
    ! Returns:                                                                 !
    !   x'                                                                     !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in) :: x
    real(kind=DP), intent(in) :: xmin, xmax

    !------------------------------------------------------------------------
    cheb_scale_x = (2.0_DP*x - xmin - xmax)/(xmax - xmin)

  end function cheb_scale_x
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  real(kind=DP) function cheb_unscale_x(xprime, xmin, xmax)
    !==========================================================================!
    ! Linear transformation of x' in [-1,1] to x in [xmin,xmax].               !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   xprime, xmin, xmax (in)                                                !
    ! Returns:                                                                 !
    !   x                                                                      !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    implicit none

    ! Arguments
    real(kind=DP), intent(in) :: xprime
    real(kind=DP), intent(in) :: xmin, xmax

    !------------------------------------------------------------------------
    cheb_unscale_x = 0.5_DP*((xprime + 1.0_DP)*xmax + (1.0_DP - xprime)*xmin)

  end function cheb_unscale_x
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_alloc_coeffs(coeffs, n_dim, n_intervals, order)
    !==========================================================================!
    ! Allocates the storage associated with a CHEB_COEFFS variable, sets its   !
    ! 'n_dim', 'n_intervals' and 'order' fields.                               !
    !                                                                          !
    ! The size of the allocated coeffs array depends on n_dim, i.e. the        !
    ! dimensions of the expansion/integration domain.                          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (out):     The CHEB_COEFFS variable to allocate.                !
    !   n_dim (in) :      The number of dimensions of the domain over which    !
    !                     the function is to be expanded (2 or 3).             !
    !   n_intervals (in): The number of intervals corresponding to sph_coeffs. !
    !   order (in):       The Chebyshev order corresponding to sph_coeffs.     !
    ! The (in) arguments are used to determine how big the storage should be.  !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    ! Updated by James C. Womack to support variable dimensionality of         !
    ! expansion/integration domain, June 2018                                  !
    !==========================================================================!

    use utils, only: utils_alloc_check, utils_assert

    implicit none

    ! Parameters
    character(len=*), parameter :: myself = 'cheb_alloc_coeffs'
    integer, parameter :: allowed_n_dim(2) = [2, 3]

    ! Arguments
    type(CHEB_COEFFS), intent(out) :: coeffs
    integer, intent(in)            :: n_dim
    integer, intent(in)            :: n_intervals
    integer, intent(in)            :: order

    ! Local variables
    integer :: n_stripes(3)
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    ! JCW: Check n_dim is an allowed value
    call utils_assert(any(n_dim == allowed_n_dim(:)),&
         "Error in "//myself//": n_dim not in allowed range, [2,3].")

    ! JCW: Initialize n_stripes along all directions to one.
    n_stripes(1:3) = 1

    ! JCW: n_dim always > 1, so stripes along z (3) and y (2) always non-zero
    n_stripes(2:3) = n_intervals * order
    if (n_dim > 2) then
       ! JCW: Set n_stripes along x (1) for n_dim > 2
       n_stripes(1) = n_intervals * order
    endif

    allocate(coeffs%xcoeffs(n_stripes(1),n_stripes(2),n_stripes(3)), stat=ierr)
    call utils_alloc_check(myself,'coeffs%xcoeffs',ierr)

    ! Set n_intervals, order -- this comes in handy in cheb_recv_coeffs
    coeffs%n_intervals = n_intervals
    coeffs%order = order

    ! JCW: Useful to store dimensions with coefficients, to check consistency
    ! JCW: with CHEB_NODES object
    coeffs%n_dim = n_dim

    call utils_trace_out(myself)
  end subroutine cheb_alloc_coeffs
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_dealloc_coeffs(coeffs)
    !==========================================================================!
    ! Deallocates the storage associated with a CHEB_COEFFS variable.          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   coeffs (inout): The CHEB_COEFFS variable to deallocate.                !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    ! Updated by James C. Womack to support changes in objects storing         !
    ! coefficients of expanded functions, June 2018                            !
    !==========================================================================!

    use utils, only: utils_dealloc_check, utils_assert

    implicit none

    ! Arguments
    type(CHEB_COEFFS), intent(inout)   :: coeffs

    ! Local variables
    character(len=*), parameter :: myself = 'cheb_dealloc_coeffs'
    integer :: ierr

    !------------------------------------------------------------------------
    call utils_trace_in(myself)

    call utils_assert(coeffs%n_intervals /= CHEB_COEFFS_ARE_INVALID, &
         myself//': Attempt to deallocate twice.')

    deallocate(coeffs%xcoeffs, stat=ierr)
    call utils_dealloc_check(myself,'coeffs%xcoeffs',ierr)
    coeffs%n_intervals = CHEB_COEFFS_ARE_INVALID ! jd: Mark as dealloced
    coeffs%order       = CHEB_COEFFS_ARE_INVALID ! JCW: same for other components
    coeffs%n_dim       = CHEB_COEFFS_ARE_INVALID

    call utils_trace_out(myself)
  end subroutine cheb_dealloc_coeffs
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_send_coeffs_initiate(handles, dest_node, coeffs, tag)
    !==========================================================================!
    ! Initiates a send of a SPHERE_COEFFS variable.                            !
    ! This calls comms_send for all the components of this derived type.       !
    ! The returned HANDLE_SET may then be tested for completion with           !
    ! cheb_test_completion.                                                    !
    !                                                                          !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   handles (out):   Here a set of handles is returned that can be used to !
    !                    test for the completion of the send, if necessary.    !
    !   dest_node (in):  The node to which the coefficents are to be sent.     !
    !   coeffs (in):     A SPHERE_COEFFS variable to be sent.                  !
    !   tag (in):        A tag for the communications.                         !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_send
    use utils, only: utils_assert

    implicit none

    ! Parameters
    character(len=*), parameter :: myself = "cheb_send_coeffs_initiate"

    ! Arguments
    type(HANDLE_SET), intent(out)   :: handles
    integer, intent(in)             :: dest_node
    type(CHEB_COEFFS), intent(in)   :: coeffs
    integer, intent(in)             :: tag

    ! Local variables
    integer :: n_stripes
    integer :: send_handles(1:n_variables_in_cheb_coeffs)

    !------------------------------------------------------------------------
    call utils_assert(coeffs%n_intervals > 0 .and. coeffs%order > 0, &
         myself//': &
         &Must first allocate the coeffs you''re sending.')

    ! --------------------------------------------------------------------------
    ! JCW: Check that Chebyshev expansion is 3-D
    ! JCW:
    ! JCW: This routine is no longer used, but is preserved in case
    ! JCW: the code becomes useful in future. To support n_dim /= 3
    ! JCW: modifications will be necessary, so usage with n_dim /= 3
    ! JCW: is blocked.
    call utils_assert(coeffs%n_dim == 3, "Error in "//myself//": &
         &Only 3-D Chebyshev expansions are supported by this routine.")
    ! --------------------------------------------------------------------------

    n_stripes = coeffs%n_intervals * coeffs%order

    call comms_send(dest_node, coeffs%n_intervals, 1, &
         tag + CHEB_ELEMENT_TAG+1, send_handles(1), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%order, 1, &
         tag + CHEB_ELEMENT_TAG+2, send_handles(2), add_to_stack = .false.)
    call comms_send(dest_node, coeffs%xcoeffs, n_stripes**3, &
         tag + CHEB_ELEMENT_TAG+3, send_handles(3), add_to_stack = .false.)

    handles%handles = send_handles

  end subroutine cheb_send_coeffs_initiate
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_recv_coeffs_initiate(handles, src_node, coeffs, tag)
    !==========================================================================!
    ! Initiates a receive of a SPHERE_COEFFS variable.                         !
    ! This calls comms_irecv for all the components of this derived type.      !
    ! The returned HANDLE_SET may then be tested for completion with           !
    ! cheb_test_completion.                                                    !
    !                                                                          !
    ! NB. This subroutine is expecting coeffs to have been allocated prior     !
    !     to the call, hence intent(inout).                                    !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   handles (out):  Here a set of handles is returned that can be used to  !
    !                   test for the completion of the receive.                !
    !   src_node (in):  The node from which the coefficents are to be received.!
    !   coeffs (inout): On input, a SPHERE_COEFFS variable allocated with      !
    !                   cheb_alloc_coeffs. On output: received coefficients.   !
    !   tag (in):       A tag for the communications.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_irecv
    use utils, only: utils_assert

    implicit none

    ! Parameters
    character(len=*), parameter :: myself = "cheb_recv_coeffs_initiate"

    ! Arguments
    type(HANDLE_SET), intent(out)      :: handles
    integer, intent(in)                :: src_node
    type(CHEB_COEFFS), intent(inout)   :: coeffs
    integer, intent(in)                :: tag

    ! Local variables
    integer :: n_stripes
    integer :: recv_handles(1:n_variables_in_cheb_coeffs)

    !------------------------------------------------------------------------
    call utils_assert(coeffs%n_intervals > 0 .and. coeffs%order > 0, &
         myself//': &
         &Must allocate the destination coeffs first.')

    ! --------------------------------------------------------------------------
    ! JCW: Check that Chebyshev expansion is 3-D
    ! JCW:
    ! JCW: This routine is no longer used, but is preserved in case
    ! JCW: the code becomes useful in future. To support n_dim /= 3
    ! JCW: modifications will be necessary, so usage with n_dim /= 3
    ! JCW: is blocked.
    call utils_assert(coeffs%n_dim == 3, "Error in "//myself//": &
         &Only 3-D Chebyshev expansions are supported by this routine.")
    ! --------------------------------------------------------------------------

    n_stripes = coeffs%n_intervals * coeffs%order

    call comms_irecv(src_node, coeffs%n_intervals, 1, &
         tag + CHEB_ELEMENT_TAG+1, handle = recv_handles(1))
    call comms_irecv(src_node, coeffs%order, 1, &
         tag + CHEB_ELEMENT_TAG+2, handle = recv_handles(2))
    call comms_irecv(src_node, coeffs%xcoeffs, n_stripes**3, &
         tag + CHEB_ELEMENT_TAG+3, handle = recv_handles(3))

    handles%handles = recv_handles

  end subroutine cheb_recv_coeffs_initiate
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  subroutine cheb_test_completion(complete, handles)
    !==========================================================================!
    ! Checks for the completion of a receive operation initiated with          !
    ! cheb_recv_coeffs_initiate or of a send operation initiated with          !
    ! cheb_send_coeffs_initiate.                                               !
    ! This subroutine is non-blocking.                                         !
    !--------------------------------------------------------------------------!
    ! Arguments:                                                               !
    !   complete (out): .true. iff the operation corresponding to 'handles'    !
    !                   completed.                                             !
    !   handles(in): identifies the operation in question -- use here what     !
    !                cheb_*_coeffs_initiate returned.                          !
    !--------------------------------------------------------------------------!
    ! Written by Jacek Dziedzic, January 2012                                  !
    !==========================================================================!

    use comms, only: comms_test

    implicit none

    ! Arguments
    logical, intent(out)         :: complete
    type(HANDLE_SET), intent(inout) :: handles

    ! Local variables
    logical :: ready(1:n_variables_in_cheb_coeffs)
    integer :: i

    ! ------------------------------------------------------------------------

    ready(:) = .false.
    do i = 1, n_variables_in_cheb_coeffs
       call comms_test(ready(i),handles%handles(i))
    end do

    complete = all(ready)

  end subroutine cheb_test_completion
  !>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

end module chebyshev_rep
